<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ğŸ¥• ë‹¹ - ìˆ™ì œ ê´€ë¦¬ì</title>

<!-- Firebase compat SDK -->
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

<style>
  * { box-sizing: border-box; }

  body {
    background: #fff5e8;
    font-family: -apple-system, BlinkMacSystemFont, "Pretendard", system-ui, sans-serif;
    margin: 0;
    padding: 16px;
    color: #4b3525;
  }

  h1 {
    text-align: center;
    color: #ff8a3c;
    margin: 0 0 6px 0;
    font-size: 22px;
  }

  .tag {
    text-align: center;
    font-size: 12px;
    color: #fff;
    background: #ffb37a;
    padding: 4px 12px;
    border-radius: 999px;
    display: inline-block;
    margin-left: 50%;
    transform: translateX(-50%);
    margin-bottom: 18px;
  }

  .section-title {
    font-size: 15px;
    font-weight: 700;
    margin-bottom: 8px;
    color: #ff8a3c;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .section-title span.sub {
    font-size: 12px;
    font-weight: 400;
    color: #b07b55;
  }

  .card {
    background: #ffffff;
    padding: 12px;
    border-radius: 14px;
    box-shadow: 0 3px 10px rgba(255,150,95,0.22);
    margin-bottom: 16px;
  }

  textarea {
    width: 100%;
    min-height: 70px;
    border-radius: 10px;
    border: 1px solid #ffcfac;
    padding: 8px;
    resize: vertical;
    font-family: inherit;
    font-size: 13px;
    background: #fffdfa;
  }

  button {
    padding: 8px 14px;
    border: none;
    border-radius: 999px;
    background: #ff8a3c;
    color: white;
    font-weight: 600;
    cursor: pointer;
    font-size: 13px;
  }
  button:active { transform: translateY(1px); }

  .btn-sub { background: #ffd2ae; color: #9f4e23; }
  .btn-danger { background: #ffebe1; color: #ff5c37; }

  .small-helper {
    font-size: 11px;
    color: #aa7c5b;
    margin-top: 2px;
  }

  .input-small-label {
    font-size: 12px;
    color: #79533a;
    margin-bottom: 4px;
  }

  /* --- ìš”ì•½ 3Ã—3 ê·¸ë¦¬ë“œ --- */

  .summary-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
    margin-top: 6px;
  }

  .summary-box {
    background: #fff0dd;
    border-radius: 14px;
    padding: 8px 6px;
    text-align: center;
    box-shadow: 0 2px 4px rgba(255,160,90,0.18);
  }

  .summary-box.sum {
    background: #ffe0c0;
  }

  .summary-label {
    font-size: 12px;
    color: #a45c2c;
    margin-bottom: 2px;
  }

  .summary-input-wrap {
    background: #fffaf3;
    border-radius: 999px;
    border: 1px solid #ffd4ae;
    padding: 4px 8px;
    display: inline-block;
    min-width: 54px;
  }

  .summary-input {
    width: 40px;
    text-align: center;
    border: none;
    background: transparent;
    font-size: 13px;
    color: #c34f1f;
  }

  .summary-input:focus { outline: none; }

  /* --- ê°„ë‹¨ ì¸í’‹ ë¼ì¸ (í–‰ ì¶”ê°€ / í•­ëª© ì¶”ê°€) --- */

  .input-line {
    display: flex;
    gap: 8px;
    margin-bottom: 8px;
  }

  .input-line input[type="text"] {
    flex: 1;
    padding: 7px;
    border-radius: 9px;
    border: 1px solid #ffd1a4;
    font-size: 13px;
    background: #fffdfa;
  }

  .pill {
    display: inline-flex;
    align-items: center;
    padding: 4px 10px;
    border-radius: 999px;
    background: #ffe9d7;
    font-size: 12px;
    margin: 2px;
    gap: 6px;
  }

  .pill button {
    padding: 0 6px;
    font-size: 11px;
    background: transparent;
    color: #ff4b24;
    box-shadow: none;
  }

  .field-list .label {
    font-size: 12px;
    color: #9a6340;
    margin-bottom: 4px;
  }

  /* --- ìˆ™ì œ ì¹´ë“œ --- */

  .space-card {
    margin-bottom: 10px;
    padding: 10px;
    border-radius: 16px;
    background: #fffdf8;
    border: 1px solid #ffe4c9;
    box-shadow: 0 2px 6px rgba(0,0,0,0.03);
  }

  .space-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 6px;
    margin-bottom: 10px;
  }

  .space-main {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .badge-nick {
    font-size: 13px;
    font-weight: 600;
    padding: 4px 10px;
    border-radius: 999px;
    background: #ffe0c2;
    color: #8b4b20;
  }

  .badge-id {
    font-size: 11px;
    padding: 4px 8px;
    border-radius: 999px;
    background: #fff6eb;
    color: #a85a23;
    display: inline-flex;
    align-items: center;
    gap: 4px;
  }

  .badge-id button {
    padding: 2px 6px;
    font-size: 10px;
    border-radius: 999px;
    background: #ffbf86;
    color: #fff;
  }

  .space-stats {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }

  .stat-box {
    flex: 1 1 calc(50% - 8px);
    min-width: 110px;
    background: #fff3e5;
    border-radius: 14px;
    padding: 8px 6px;
    text-align: center;
  }

  .stat-label {
    font-size: 12px;
    color: #a45526;
    margin-bottom: 2px;
  }

  .stat-input-wrap {
    border-radius: 999px;
    border: 1px solid #ffd4ae;
    background: #fff;
    padding: 4px 10px;
    display: inline-block;
    min-width: 60px;
  }

  .stat-input {
    width: 44px;
    border: none;
    background: transparent;
    text-align: center;
    font-size: 14px;
    color: #c34f1f;
  }

  .stat-input:focus { outline: none; }

  .space-bottom {
    display: flex;
    gap: 8px;
    margin-top: 8px;
  }

  .space-memo { flex: 1; }

  .space-balloons {
    width: 80px;
    text-align: center;
  }

  .space-balloons-input {
    width: 100%;
    border-radius: 10px;
    border: 1px solid #ffd1a4;
    padding: 6px 4px;
    text-align: center;
    font-size: 13px;
    background: #fffdfa;
  }

  .btn-complete {
    background: #ff8fb0;
    color: #fff;
    font-size: 12px;
    padding: 6px 12px;
  }

  @media (min-width: 720px) {
    body {
      max-width: 640px;
      margin: 0 auto;
    }
  }
</style>
</head>

<body>
<h1>ğŸ¥• ë‹¹ - ìˆ™ì œ ê´€ë¦¬ì</h1>
<div class="tag">ê´€ë¦¬ì ID: ë‹¹ (ì£¼í™©)</div>

<!-- ì˜¤ëŠ˜ì˜ í•œë§ˆë”” -->
<div class="card">
  <div class="section-title">ğŸ“Œ ì˜¤ëŠ˜ì˜ í•œë§ˆë”” <span class="sub">(ê´€ë¦¬ì â†” ì‚¬ìš©ì)</span></div>

  <div class="input-small-label">ğŸ¥• ê´€ë¦¬ì â†’ ë‚­</div>
  <textarea id="adminMessage" placeholder="ë‚­ì—ê²Œ ì˜¤ëŠ˜ ì „í•˜ê³  ì‹¶ì€ ë§"></textarea>
  <div style="margin-top:6px; text-align:right;">
    <button onclick="saveAdminMessage()">ê´€ë¦¬ì í•œë§ˆë”” ì €ì¥</button>
  </div>

  <div style="height:10px;"></div>

  <div class="input-small-label">ğŸ° ë‚­ â†’ ê´€ë¦¬ì</div>
  <div id="userMessageBox"
       style="white-space:pre-line; padding:8px; border-radius:10px; border:1px solid #ffd7c2; background:#fff8f3; font-size:13px;">
    (ì•„ì§ ì‚¬ìš©ì ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤)
  </div>
</div>

<!-- ì˜¤ëŠ˜ ìˆ™ì œ ìš”ì•½ (3Ã—3) -->
<div class="card">
  <div class="section-title">
    ğŸ“¦ <span id="todayTitleDate">ì˜¤ëŠ˜ ìˆ™ì œ</span>
  </div>
  <div class="small-helper">â€» ì˜¤ëŠ˜ ê¸°ì¤€ìœ¼ë¡œ ì§ì ‘ ìˆ«ìë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.</div>

  <div class="summary-grid" id="todayGrid">
    <!-- 1í–‰ -->
    <div class="summary-box">
      <div class="summary-label">ë°°ë¯¼</div>
      <div class="summary-input-wrap">
        <input id="today-ë°°ë¯¼" type="number" class="summary-input" value="0" />
      </div>
    </div>
    <div class="summary-box">
      <div class="summary-label">ë°©ì…€</div>
      <div class="summary-input-wrap">
        <input id="today-ë°©ì…€" type="number" class="summary-input" value="0" />
      </div>
    </div>
    <div class="summary-box">
      <div class="summary-label">ì›€ì§¤</div>
      <div class="summary-input-wrap">
        <input id="today-ì›€ì§¤" type="number" class="summary-input" value="0" />
      </div>
    </div>
    <!-- 2í–‰ -->
    <div class="summary-box">
      <div class="summary-label">ì—­íŒ¬</div>
      <div class="summary-input-wrap">
        <input id="today-ì—­íŒ¬" type="number" class="summary-input" value="0" />
      </div>
    </div>
    <div class="summary-box">
      <div class="summary-label">ì •ì„±</div>
      <div class="summary-input-wrap">
        <input id="today-ì •ì„±" type="number" class="summary-input" value="0" />
      </div>
    </div>
    <div class="summary-box">
      <div class="summary-label">ì‚¬ì§„</div>
      <div class="summary-input-wrap">
        <input id="today-ì‚¬ì§„" type="number" class="summary-input" value="0" />
      </div>
    </div>
    <!-- 3í–‰ -->
    <div class="summary-box sum">
      <div class="summary-label">í•©ê³„</div>
      <div class="summary-input-wrap">
        <input id="today-í•©ê³„-left" type="number" class="summary-input" value="0" />
      </div>
    </div>
    <div class="summary-box">
      <div class="summary-label">ì˜ìƒ</div>
      <div class="summary-input-wrap">
        <input id="today-ì˜ìƒ" type="number" class="summary-input" value="0" />
      </div>
    </div>
    <div class="summary-box sum">
      <div class="summary-label">í•©ê³„</div>
      <div class="summary-input-wrap">
        <input id="today-í•©ê³„-right" type="number" class="summary-input" value="0" />
      </div>
    </div>
  </div>

  <div style="margin-top:8px; text-align:right;">
    <button class="btn-sub" onclick="saveSummary('today')">ì˜¤ëŠ˜ ìš”ì•½ ì €ì¥</button>
  </div>
</div>

<!-- ë°€ë¦° ìˆ™ì œ ìš”ì•½ (3Ã—3) -->
<div class="card">
  <div class="section-title">ğŸ“¦ ë°€ë¦° ìˆ™ì œ</div>
  <div class="small-helper">â€» ì§€ê¸ˆê¹Œì§€ ë°€ë¦° ìˆ™ì œë¥¼ ì§ì ‘ ì…ë ¥í•´ ì£¼ì„¸ìš”.</div>

  <div class="summary-grid" id="lateGrid">
    <!-- 1í–‰ -->
    <div class="summary-box">
      <div class="summary-label">ë°°ë¯¼</div>
      <div class="summary-input-wrap">
        <input id="late-ë°°ë¯¼" type="number" class="summary-input" value="0" />
      </div>
    </div>
    <div class="summary-box">
      <div class="summary-label">ë°©ì…€</div>
      <div class="summary-input-wrap">
        <input id="late-ë°©ì…€" type="number" class="summary-input" value="0" />
      </div>
    </div>
    <div class="summary-box">
      <div class="summary-label">ì›€ì§¤</div>
      <div class="summary-input-wrap">
        <input id="late-ì›€ì§¤" type="number" class="summary-input" value="0" />
      </div>
    </div>
    <!-- 2í–‰ -->
    <div class="summary-box">
      <div class="summary-label">ì—­íŒ¬</div>
      <div class="summary-input-wrap">
        <input id="late-ì—­íŒ¬" type="number" class="summary-input" value="0" />
      </div>
    </div>
    <div class="summary-box">
      <div class="summary-label">ì •ì„±</div>
      <div class="summary-input-wrap">
        <input id="late-ì •ì„±" type="number" class="summary-input" value="0" />
      </div>
    </div>
    <div class="summary-box">
      <div class="summary-label">ì‚¬ì§„</div>
      <div class="summary-input-wrap">
        <input id="late-ì‚¬ì§„" type="number" class="summary-input" value="0" />
      </div>
    </div>
    <!-- 3í–‰ -->
    <div class="summary-box sum">
      <div class="summary-label">í•©ê³„</div>
      <div class="summary-input-wrap">
        <input id="late-í•©ê³„-left" type="number" class="summary-input" value="0" />
      </div>
    </div>
    <div class="summary-box">
      <div class="summary-label">ì˜ìƒ</div>
      <div class="summary-input-wrap">
        <input id="late-ì˜ìƒ" type="number" class="summary-input" value="0" />
      </div>
    </div>
    <div class="summary-box sum">
      <div class="summary-label">í•©ê³„</div>
      <div class="summary-input-wrap">
        <input id="late-í•©ê³„-right" type="number" class="summary-input" value="0" />
      </div>
    </div>
  </div>

  <div style="margin-top:8px; text-align:right;">
    <button class="btn-sub" onclick="saveSummary('late')">ë°€ë¦° ìˆ™ì œ ì €ì¥</button>
  </div>
</div>

<!-- ìˆ™ì œ ëŒ€ìƒ ì¶”ê°€ -->
<div class="card">
  <div class="section-title">ğŸ“‹ ìˆ™ì œ ëŒ€ìƒ ì¶”ê°€</div>
  <div class="input-small-label">ë‹‰ë„¤ì„ / ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ê³  í–‰ì„ ì¶”ê°€í•˜ì„¸ìš”.</div>
  <div class="input-line">
    <input type="text" id="newNick" placeholder="ë‹‰ë„¤ì„" />
    <input type="text" id="newID" placeholder="ì•„ì´ë””" />
    <button onclick="addSpace()">ì¶”ê°€</button>
  </div>
</div>

<!-- í•­ëª© ê´€ë¦¬ -->
<div class="card">
  <div class="section-title">ğŸ“Œ í•­ëª© ê´€ë¦¬</div>
  <div class="input-small-label">ì¹´ë“œì—ì„œ ì‚¬ìš©í•  í•­ëª©(ì—´ ì´ë¦„)ì„ ê´€ë¦¬í•©ë‹ˆë‹¤.</div>
  <div class="input-line">
    <input type="text" id="newField" placeholder="ìƒˆ í•­ëª© ì´ë¦„ (ì˜ˆ: ì—­íŒ¬ / ë°©ì…€ / ìˆ™ì œ ...)" />
    <button onclick="addField()">í•­ëª© ì¶”ê°€</button>
  </div>
  <div class="field-list">
    <div class="label">í˜„ì¬ í•­ëª©ë“¤</div>
    <div id="fieldPills"></div>
  </div>
</div>

<!-- ìˆ™ì œ ì¹´ë“œ ëª©ë¡ -->
<div class="card">
  <div class="section-title">ğŸ“¦ ìˆ™ì œ ì¹´ë“œ</div>
  <div class="small-helper">ì²´í¬(ìˆ«ì ì¹´ìš´íŠ¸)ì™€ ë©”ëª¨, í’ì„  ê°¯ìˆ˜ë¥¼ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì™„ë£Œëœ ì¹´ë“œëŠ” â€œì™„ë£ŒğŸ°â€ë¡œ ì •ë¦¬í•˜ì„¸ìš”.</div>
  <div id="spacesContainer"></div>
</div>

<script>
  /* Firebase ì´ˆê¸°í™” */
  const firebaseConfig = {
    apiKey: "AIzaSyAHmLNi5VOuAE-gXnAg-fEfzylPZvzvfVo",
    authDomain: "daily-checklist-91e5a.firebaseapp.com",
    projectId: "daily-checklist-91e5a",
    storageBucket: "daily-checklist-91e5a.firebasestorage.app",
    messagingSenderId: "66394691958",
    appId: "1:66394691958:web:cf91f295456a2e10d18257",
    measurementId: "G-87WK4N4EGH"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  /* ê³µí†µ ìƒìˆ˜ */
  const STAT_KEYS = ["ë°°ë¯¼", "ë°©ì…€", "ì›€ì§¤", "ì—­íŒ¬", "ì •ì„±", "ì‚¬ì§„", "ì˜ìƒ"];
  const SUM_LEFT = "í•©ê³„ì¢Œ";
  const SUM_RIGHT = "í•©ê³„ìš°";

  const emptySummary = {};
  STAT_KEYS.forEach(k => emptySummary[k] = 0);
  emptySummary[SUM_LEFT] = 0;
  emptySummary[SUM_RIGHT] = 0;

  /* ì»¬ë ‰ì…˜ ì°¸ì¡° */
  const todayMessagesRef = db.collection("today").doc("messages");
  const summaryTodayRef  = db.collection("summary").doc("today_v2");
  const summaryLateRef   = db.collection("summary").doc("late_v2");
  const configRef        = db.collection("config").doc("checklist");
  const spacesRef        = db.collection("spaces");

  let fields = [];
  let spacesData = [];

  /* ì˜¤ëŠ˜ ë‚ ì§œ íƒ€ì´í‹€ ì„¤ì • */
  (function setTodayTitle(){
    const now = new Date();
    const m = now.getMonth() + 1;
    const d = now.getDate();
    const wNames = ["ì¼","ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ","í† "];
    const w = wNames[now.getDay()];
    document.getElementById("todayTitleDate").innerText = `${m}ì›” ${d}ì¼(${w}) ìˆ™ì œ`;
  })();

  /* --- ì˜¤ëŠ˜ì˜ í•œë§ˆë”” ì‹¤ì‹œê°„ --- */

  todayMessagesRef.onSnapshot(doc => {
    if (!doc.exists) {
      todayMessagesRef.set({
        adminMessage: "",
        userMessage: "",
        date: new Date().toISOString()
      }, { merge: true });
      return;
    }
    const data = doc.data();
    document.getElementById("adminMessage").value = data.adminMessage || "";
    document.getElementById("userMessageBox").innerText =
      data.userMessage || "(ì•„ì§ ì‚¬ìš©ì ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤)";
  });

  function saveAdminMessage() {
    const msg = document.getElementById("adminMessage").value;
    todayMessagesRef.set({
      adminMessage: msg,
      date: new Date().toISOString()
    }, { merge: true }).then(()=>{
      alert("ê´€ë¦¬ì í•œë§ˆë””ë¥¼ ì €ì¥í–ˆì–´ìš”.");
    }).catch(e=>{
      console.error(e);
      alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.");
    });
  }

  /* --- ìš”ì•½: ì…ë ¥ê°’ â†’ payload, payload â†’ ì…ë ¥ê°’ --- */

  function renderSummary(prefix, data) {
    const d = Object.assign({}, emptySummary, data || {});
    function set(id, val){
      const el = document.getElementById(prefix + "-" + id);
      if (el) el.value = val ?? 0;
    }
    STAT_KEYS.forEach(name => set(name, d[name]));
    // í•©ê³„ê°€ ì—†ìœ¼ë©´ ìë™ ê³„ì‚°
    const left = (d[SUM_LEFT] != null)
      ? d[SUM_LEFT]
      : (Number(d["ë°°ë¯¼"]||0) + Number(d["ì—­íŒ¬"]||0));
    const right = (d[SUM_RIGHT] != null)
      ? d[SUM_RIGHT]
      : (Number(d["ì›€ì§¤"]||0) + Number(d["ì‚¬ì§„"]||0));

    set("í•©ê³„-left", left);
    set("í•©ê³„-right", right);
  }

  function collectSummary(prefix) {
    const payload = {};
    function get(id){
      const el = document.getElementById(prefix + "-" + id);
      return el ? Number(el.value || 0) : 0;
    }
    STAT_KEYS.forEach(name => payload[name] = get(name));
    payload[SUM_LEFT] = get("í•©ê³„-left");
    payload[SUM_RIGHT] = get("í•©ê³„-right");
    payload.updatedAt = new Date();
    return payload;
  }

  function setupAutoSum(prefix) {
    function recalc() {
      function get(id){
        const el = document.getElementById(prefix + "-" + id);
        return el ? Number(el.value || 0) : 0;
      }
      const left = get("ë°°ë¯¼") + get("ì—­íŒ¬");
      const right = get("ì›€ì§¤") + get("ì‚¬ì§„");
      const leftEl = document.getElementById(prefix + "-í•©ê³„-left");
      const rightEl = document.getElementById(prefix + "-í•©ê³„-right");
      if (leftEl) leftEl.value = left;
      if (rightEl) rightEl.value = right;
    }
    ["ë°°ë¯¼","ì—­íŒ¬","ì›€ì§¤","ì‚¬ì§„"].forEach(name=>{
      const el = document.getElementById(prefix + "-" + name);
      if (el) el.addEventListener("input", recalc);
    });
  }

  function saveSummary(which) {
    const prefix = (which === "today") ? "today" : "late";
    const ref = (which === "today") ? summaryTodayRef : summaryLateRef;
    const payload = collectSummary(prefix);
    ref.set(payload, { merge:true }).then(()=>{
      alert((which === "today" ? "ì˜¤ëŠ˜" : "ë°€ë¦°") + " ìˆ™ì œë¥¼ ì €ì¥í–ˆì–´ìš”.");
    }).catch(e=>{
      console.error(e);
      alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.");
    });
  }

  /* ìš”ì•½ ìŠ¤ëƒ…ìƒ· */

  summaryTodayRef.onSnapshot(doc=>{
    renderSummary("today", doc.exists ? doc.data() : emptySummary);
    setupAutoSum("today");
  });

  summaryLateRef.onSnapshot(doc=>{
    renderSummary("late", doc.exists ? doc.data() : emptySummary);
    setupAutoSum("late");
  });

  /* --- í•­ëª© ê´€ë¦¬ --- */

  configRef.onSnapshot(doc=>{
    if (!doc.exists) {
      configRef.set({ fields: [] });
      return;
    }
    fields = doc.data().fields || [];
    renderFieldPills();
    renderSpaces();
  });

  function addField() {
    const input = document.getElementById("newField");
    const name = input.value.trim();
    if (!name) return;
    configRef.update({
      fields: firebase.firestore.FieldValue.arrayUnion(name)
    }).then(()=>{ input.value = ""; })
      .catch(err=>{
        console.error(err);
        alert("í•­ëª© ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.");
      });
  }

  function deleteField(name) {
    if (!confirm(`"${name}" í•­ëª©ì„ ì‚­ì œí• ê¹Œìš”?`)) return;
    configRef.update({
      fields: firebase.firestore.FieldValue.arrayRemove(name)
    }).catch(err=>{
      console.error(err);
      alert("í•­ëª© ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.");
    });
  }

  function renderFieldPills() {
    const wrap = document.getElementById("fieldPills");
    wrap.innerHTML = "";
    if (!fields.length) {
      wrap.innerHTML = '<div class="small-helper">ì•„ì§ ë“±ë¡ëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
      return;
    }
    fields.forEach(name=>{
      const pill = document.createElement("div");
      pill.className = "pill";
      pill.innerHTML = `
        <span>${name}</span>
        <button type="button" onclick="deleteField('${name}')">X</button>
      `;
      wrap.appendChild(pill);
    });
  }

  /* --- ìˆ™ì œ ëŒ€ìƒ (spaces) --- */

  spacesRef.onSnapshot(snapshot=>{
    spacesData = snapshot.docs.map(d => ({
      id: d.id,
      ...d.data()
    }));
    renderSpaces();
  });

  function addSpace() {
    const nickEl = document.getElementById("newNick");
    const idEl   = document.getElementById("newID");
    const nickname = nickEl.value.trim();
    const userid   = idEl.value.trim();
    if (!nickname || !userid) {
      alert("ë‹‰ë„¤ì„ê³¼ ì•„ì´ë””ë¥¼ ëª¨ë‘ ì…ë ¥í•´ ì£¼ì„¸ìš”.");
      return;
    }

    // ê¸°ë³¸ ì¹´ìš´íŠ¸ ê°ì²´
    const counts = {};
    fields.forEach(f => counts[f] = 0);

    spacesRef.add({
      nickname,
      userid,
      memo: "",
      balloons: 0,
      counts
    }).then(()=>{
      nickEl.value = "";
      idEl.value = "";
    }).catch(err=>{
      console.error(err);
      alert("í–‰ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.");
    });
  }

  function copyUserId(value) {
    if (!value) return;
    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(value).then(()=>{
        alert("ì•„ì´ë””ë¥¼ ë³µì‚¬í–ˆì–´ìš”: " + value);
      }).catch(()=>{
        alert("ë³µì‚¬ ì¤‘ ë¬¸ì œê°€ ìƒê²¼ì–´ìš”. ì§ì ‘ ë³µì‚¬í•´ ì£¼ì„¸ìš”.");
      });
    } else {
      alert("ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” ìë™ ë³µì‚¬ê°€ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì§ì ‘ ë³µì‚¬í•´ ì£¼ì„¸ìš”.");
    }
  }

  function updateSpaceField(docId, field, value) {
    spacesRef.doc(docId).update({ [field]: value })
      .catch(err=>{
        console.error(err);
        alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.");
      });
  }

  function updateSpaceCount(docId, fieldName, value) {
    const num = Number(value || 0);
    spacesRef.doc(docId).update({
      [`counts.${fieldName}`]: num
    }).catch(err=>{
      console.error(err);
      alert("ì¹´ìš´íŠ¸ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.");
    });
  }

  function deleteSpace(docId) {
    if (!confirm("ì •ë§ ì´ ì¹´ë“œë¥¼ 'ì™„ë£Œ' ì²˜ë¦¬í• ê¹Œìš”?\nì™„ë£Œí•˜ë©´ ëª©ë¡ì—ì„œ ì‚¬ë¼ì§‘ë‹ˆë‹¤.")) return;
    spacesRef.doc(docId).delete()
      .catch(err=>{
        console.error(err);
        alert("ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.");
      });
  }

  function renderSpaces() {
    const container = document.getElementById("spacesContainer");
    container.innerHTML = "";

    if (!spacesData.length) {
      container.innerHTML = '<div class="small-helper">ì•„ì§ ì¶”ê°€ëœ ìˆ™ì œ ëŒ€ìƒì´ ì—†ìŠµë‹ˆë‹¤.</div>';
      return;
    }

    spacesData.forEach(item=>{
      const counts = item.counts || {};
      const card = document.createElement("div");
      card.className = "space-card";

      const statsHTML = (fields && fields.length)
        ? fields.map(name=>{
            const val = counts[name] ?? 0;
            return `
              <div class="stat-box">
                <div class="stat-label">${name}</div>
                <div class="stat-input-wrap">
                  <input type="number" class="stat-input"
                         value="${val}"
                         onchange="updateSpaceCount('${item.id}','${name}',this.value)" />
                </div>
              </div>`;
          }).join("")
        : '<div class="small-helper">í˜„ì¬ ì„¤ì •ëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤. ìœ„ì—ì„œ í•­ëª©ì„ ì¶”ê°€í•´ ì£¼ì„¸ìš”.</div>';

      card.innerHTML = `
        <div class="space-header">
          <div class="space-main">
            <div class="badge-nick">
              ë‹‰ë„¤ì„:
              <input type="text"
                     value="${item.nickname || ""}"
                     style="border:none;background:transparent;width:120px;font-size:13px;"
                     onchange="updateSpaceField('${item.id}','nickname',this.value)" />
            </div>
            <div class="badge-id">
              <span>ì•„ì´ë””: ${item.userid || ""}</span>
              <button type="button" onclick="copyUserId('${item.userid || ""}')">ë³µì‚¬</button>
            </div>
          </div>
          <button class="btn-complete" type="button" onclick="deleteSpace('${item.id}')">
            ì™„ë£Œ ğŸ°
          </button>
        </div>

        <div class="space-stats">
          ${statsHTML}
        </div>

        <div class="space-bottom">
          <div class="space-memo">
            <div class="input-small-label">ë©”ëª¨</div>
            <textarea onchange="updateSpaceField('${item.id}','memo',this.value)">${item.memo || ""}</textarea>
          </div>
          <div class="space-balloons">
            <div class="input-small-label">í’ì„ </div>
            <input type="number" min="0"
                   class="space-balloons-input"
                   value="${item.balloons ?? 0}"
                   onchange="updateSpaceField('${item.id}','balloons',Number(this.value||0))" />
          </div>
        </div>
      `;

      container.appendChild(card);
    });
  }
</script>
</body>
</html>
