<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ğŸ° ë‚­ - ìˆ™ì œ ì²´í¬ (D ë²„ì „)</title>

<!-- Firebase compat SDK -->
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

<style>
    * { box-sizing: border-box; }

    body {
        margin: 0;
        padding: 16px;
        font-family: -apple-system, BlinkMacSystemFont, "Pretendard", system-ui, sans-serif;
        background: linear-gradient(180deg, #ffe0f5 0%, #ffeef8 40%, #fff7fc 100%);
        color: #4b2540;
    }

    h1 {
        margin: 0 0 6px 0;
        text-align: center;
        font-size: 22px;
        color: #ff6fa8;
    }

    .tag {
        display: inline-block;
        margin-left: 50%;
        transform: translateX(-50%);
        margin-bottom: 18px;
        padding: 4px 14px;
        font-size: 12px;
        color: #fff;
        background: #ff9ac5;
        border-radius: 999px;
    }

    .card {
        background: #ffffff;
        border-radius: 16px;
        padding: 14px 12px;
        box-shadow: 0 3px 12px rgba(255, 140, 170, 0.25);
        margin-bottom: 16px;
    }

    .section-title {
        font-size: 15px;
        font-weight: 700;
        color: #ff6fa8;
        display: flex;
        align-items: center;
        gap: 6px;
        margin-bottom: 8px;
    }

    .section-title span.sub {
        font-size: 12px;
        font-weight: 400;
        color: #b4688c;
    }

    .label-line {
        font-size: 13px;
        color: #b4688c;
        margin-bottom: 4px;
        display: flex;
        align-items: center;
        gap: 4px;
    }

    textarea {
        width: 100%;
        min-height: 70px;
        resize: vertical;
        border-radius: 10px;
        border: 1px solid #ffc5de;
        padding: 8px;
        font-size: 13px;
        font-family: inherit;
        background: #fff5fb;
    }

    button {
        border: none;
        border-radius: 999px;
        padding: 8px 16px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        background: #ff6fa8;
        color: #fff;
    }
    button:active { transform: translateY(1px); }

    .btn-sub {
        background: #ffd0e4;
        color: #b4437c;
    }

    .helper {
        font-size: 11px;
        color: #b4688c;
        margin-top: 4px;
    }

    /* ìš”ì•½ í…Œì´ë¸” */
    .summary-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 12px;
        margin-top: 4px;
    }
    .summary-table th,
    .summary-table td {
        border: 1px solid #ffd4ec;
        padding: 4px 6px;
        text-align: center;
        white-space: nowrap;
    }
    .summary-table th {
        background: #ffc4e1;
        color: #a23f73;
        font-weight: 600;
    }
    .summary-label-cell {
        background: #ffe3f2;
        font-weight: 600;
    }

    /* ìˆ™ì œ ì¹´ë“œ */
    .tasks-note {
        font-size: 11px;
        color: #b4688c;
        margin-bottom: 4px;
    }

    .space-card {
        margin-bottom: 10px;
        padding: 10px;
        border-radius: 14px;
        background: #fff3fb;
        border: 1px solid #ffd2ea;
        box-shadow: 0 2px 8px rgba(255, 140, 190, 0.18);
        animation: cardPop 0.25s ease-out;
    }

    @keyframes cardPop {
        from { transform: translateY(4px); opacity: 0; }
        to   { transform: translateY(0); opacity: 1; }
    }

    .space-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 6px;
        margin-bottom: 8px;
    }

    .space-main {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .badge-nick {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 999px;
        background: #ffcbe3;
        font-size: 13px;
        font-weight: 600;
        color: #a23f73;
    }

    .badge-nick span.nick-text {
        margin-left: 4px;
    }

    .badge-id {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 10px;
        border-radius: 999px;
        background: #ffe6f4;
        font-size: 11px;
        color: #a23f73;
    }

    .copy-btn {
        padding: 2px 8px;
        font-size: 11px;
        border-radius: 999px;
        background: #ff9ac5;
    }

    .delete-btn {
        padding: 4px 10px;
        font-size: 11px;
        border-radius: 999px;
        background: #ffd0e4;
        color: #b4437c;
        display: inline-flex;
        align-items: center;
        gap: 4px;
    }

    /* ì¹´ìš´íŠ¸ ì¹© */
    .count-row {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-bottom: 6px;
    }

    .count-chip {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 8px;
        border-radius: 999px;
        background: #ffe0f2;
        font-size: 11px;
    }

    .count-label {
        min-width: 32px;
    }

    .count-controls {
        display: inline-flex;
        align-items: center;
        gap: 3px;
    }

    .count-controls input {
        width: 40px;
        padding: 3px 0;
        border-radius: 8px;
        border: 1px solid #ffb9dd;
        background: #fff6fb;
        text-align: center;
        font-size: 11px;
    }

    .count-btn {
        padding: 0;
        width: 22px;
        height: 22px;
        border-radius: 50%;
        background: #ff9ac5;
        color: #fff;
        font-size: 15px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .space-memo textarea {
        min-height: 46px;
        font-size: 12px;
    }

    @media (min-width: 720px) {
        body {
            max-width: 640px;
            margin: 0 auto;
        }
    }
</style>
</head>

<body>

<h1>ğŸ° ë‚­ - ìˆ™ì œ ì²´í¬</h1>
<div class="tag">ì‚¬ìš©ì ID: ë‚­ (í•‘í¬)</div>

<!-- ì˜¤ëŠ˜ì˜ í•œë§ˆë”” -->
<div class="card">
    <div class="section-title">ğŸ“Œ ì˜¤ëŠ˜ì˜ í•œë§ˆë”” <span class="sub">(ê´€ë¦¬ì â†” ë‚­)</span></div>

    <div class="label-line">ğŸ¥• ê´€ë¦¬ì â†’ ë‚­</div>
    <div id="adminMessageBox"
         style="white-space:pre-line; padding:8px; border-radius:10px; border:1px solid #ffc5de; background:#fff5fb; font-size:13px; margin-bottom:8px;">
        (ê´€ë¦¬ìê°€ ì•„ì§ ë©”ì‹œì§€ë¥¼ ë‚¨ê¸°ì§€ ì•Šì•˜ì–´ìš”)
    </div>

    <div class="label-line">ğŸ° ë‚­ â†’ ê´€ë¦¬ì</div>
    <textarea id="userMessage" placeholder="ì˜¤ëŠ˜ í•˜ê³  ì‹¶ì€ ë§ì„ ì ì–´ì£¼ì„¸ìš”"></textarea>
    <div style="margin-top:6px; text-align:right;">
        <button onclick="saveUserMessage()">ì €ì¥</button>
    </div>
</div>

<!-- ì˜¤ëŠ˜ì˜ ìˆ™ì œ (MMì›” DDì¼ (ìš”ì¼) ìˆ™ì œ) -->
<div class="card">
    <div class="section-title">
        ğŸ“Š <span id="todayTitleText"></span>
    </div>

    <table class="summary-table">
        <tr>
            <th></th>
            <th>ìˆ™ì œ</th>
            <th>ì—­íŒ¬</th>
            <th>ë°©ì…€</th>
            <th>ì •ì„±</th>
            <th>ì˜ìƒ</th>
            <th>ì›€ì§¤</th>
            <th>ì‚¬ì§„</th>
        </tr>
        <tr>
            <td class="summary-label-cell">ì˜¤ëŠ˜</td>
            <td id="today-ìˆ™ì œ">0</td>
            <td id="today-ì—­íŒ¬">0</td>
            <td id="today-ë°©ì…€">0</td>
            <td id="today-ì •ì„±">0</td>
            <td id="today-ì˜ìƒ">0</td>
            <td id="today-ì›€ì§¤">0</td>
            <td id="today-ì‚¬ì§„">0</td>
        </tr>
    </table>
</div>

<!-- ë°€ë¦° ìˆ™ì œ -->
<div class="card">
    <div class="section-title">ğŸ“Š ë°€ë¦° ìˆ™ì œ</div>

    <table class="summary-table">
        <tr>
            <th></th>
            <th>ìˆ™ì œ</th>
            <th>ì—­íŒ¬</th>
            <th>ë°©ì…€</th>
            <th>ì •ì„±</th>
            <th>ì˜ìƒ</th>
            <th>ì›€ì§¤</th>
            <th>ì‚¬ì§„</th>
        </tr>
        <tr>
            <td class="summary-label-cell">ëˆ„ì </td>
            <td id="total-ìˆ™ì œ">0</td>
            <td id="total-ì—­íŒ¬">0</td>
            <td id="total-ë°©ì…€">0</td>
            <td id="total-ì •ì„±">0</td>
            <td id="total-ì˜ìƒ">0</td>
            <td id="total-ì›€ì§¤">0</td>
            <td id="total-ì‚¬ì§„">0</td>
        </tr>
    </table>
</div>

<!-- ìˆ™ì œ ì¹´ë“œ -->
<div class="card">
    <div class="section-title">ğŸ“¦ ìˆ™ì œ ì¹´ë“œ</div>
    <div class="tasks-note">
        ì²´í¬ ëŒ€ì‹  <b>ìˆ˜ëŸ‰</b>ì„ ì ëŠ” ë°©ì‹ì´ì—ìš”.  
        ë‚¨ì€ ìˆ™ì œ ê°¯ìˆ˜ë¥¼ ë§ì¶°ê°€ë©´ì„œ ì¤„ì—¬ ì£¼ì„¸ìš”. ì™„ì „íˆ ëë‚œ ì¹´ë“œëŠ” ì‚­ì œ ğŸ° ë²„íŠ¼ìœ¼ë¡œ ì •ë¦¬í•  ìˆ˜ ìˆì–´ìš”.
    </div>
    <div id="spacesContainer"></div>
</div>

<script>
/* ================================
   Firebase ì´ˆê¸°í™”
================================ */
const firebaseConfig = {
    apiKey: "AIzaSyAHmLNi5VOuAE-gXnAg-fEfzylPZvzvfVo",
    authDomain: "daily-checklist-91e5a.firebaseapp.com",
    projectId: "daily-checklist-91e5a",
    storageBucket: "daily-checklist-91e5a.firebasestorage.app",
    messagingSenderId: "66394691958",
    appId: "1:66394691958:web:cf91f295456a2e10d18257",
    measurementId: "G-87WK4N4EGH"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ================================
   Firestore Ref
================================ */
const todayMessagesRef = db.collection("today").doc("messages");
const summaryTodayRef  = db.collection("summary").doc("today");
const summaryTotalRef  = db.collection("summary").doc("total");
const spacesRef        = db.collection("spaces");

/* í•­ëª© ì´ë¦„ (ìˆœì„œ ì¤‘ìš”) */
const statNames = ["ìˆ™ì œ","ì—­íŒ¬","ë°©ì…€","ì •ì„±","ì˜ìƒ","ì›€ì§¤","ì‚¬ì§„"];

/* ================================
   ì˜¤ëŠ˜ ì œëª© (MMì›” DDì¼ (ìš”ì¼) ìˆ™ì œ)
================================ */
function setTodayTitle() {
    const now = new Date();
    const month = now.getMonth() + 1;
    const date  = now.getDate();
    const dayNames = ["ì¼","ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ","í† "];
    const day = dayNames[now.getDay()];
    document.getElementById("todayTitleText").innerText =
        `${month}ì›” ${date}ì¼ (${day}) ìˆ™ì œ`;
}

/* ================================
   ì˜¤ëŠ˜ì˜ í•œë§ˆë”” â€“ ì‹¤ì‹œê°„
================================ */
todayMessagesRef.onSnapshot(doc => {
    if (!doc.exists) {
        todayMessagesRef.set({
            adminMessage: "",
            userMessage: "",
            date: new Date().toISOString()
        }, { merge: true });
        return;
    }
    const data = doc.data();
    document.getElementById("adminMessageBox").innerText =
        data.adminMessage || "(ê´€ë¦¬ìê°€ ì•„ì§ ë©”ì‹œì§€ë¥¼ ë‚¨ê¸°ì§€ ì•Šì•˜ì–´ìš”)";
    document.getElementById("userMessage").value =
        data.userMessage || "";
});

/* ë‚­ â†’ ê´€ë¦¬ì ë©”ì‹œì§€ ì €ì¥ */
function saveUserMessage() {
    const msg = document.getElementById("userMessage").value || "";
    todayMessagesRef.set({
        userMessage: msg,
        date: new Date().toISOString()
    }, { merge: true })
    .then(() => alert("ë©”ì‹œì§€ë¥¼ ì €ì¥í–ˆì–´ìš”."))
    .catch(err => {
        console.error(err);
        alert("ì €ì¥ ì¤‘ ë¬¸ì œê°€ ìƒê²¼ì–´ìš”.");
    });
}

/* ================================
   ì˜¤ëŠ˜ / ë°€ë¦° ìˆ™ì œ ìš”ì•½ â€“ ì‹¤ì‹œê°„
================================ */
const emptySummary = {};
statNames.forEach(n => emptySummary[n] = 0);

summaryTodayRef.onSnapshot(doc => {
    if (!doc.exists) {
        summaryTodayRef.set(emptySummary, { merge: true });
        return;
    }
    const data = doc.data() || {};
    statNames.forEach(name => {
        const el = document.getElementById("today-" + name);
        if (el) el.innerText = data[name] ?? 0;
    });
});

summaryTotalRef.onSnapshot(doc => {
    if (!doc.exists) {
        summaryTotalRef.set(emptySummary, { merge: true });
        return;
    }
    const data = doc.data() || {};
    statNames.forEach(name => {
        const el = document.getElementById("total-" + name);
        if (el) el.innerText = data[name] ?? 0;
    });
});

/* ================================
   ìˆ™ì œ ì¹´ë“œ â€“ ì‹¤ì‹œê°„
================================ */
let spacesData = [];

spacesRef.onSnapshot(snapshot => {
    spacesData = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
    renderSpaces();
});

/* ì•„ì´ë”” ë³µì‚¬ */
function copyUserId(value) {
    if (!value) return;
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(value)
            .then(() => alert("ì•„ì´ë””ë¥¼ ë³µì‚¬í–ˆì–´ìš”: " + value))
            .catch(() => alert("ë³µì‚¬ ì¤‘ ë¬¸ì œê°€ ìƒê²¼ì–´ìš”. ì§ì ‘ ë³µì‚¬í•´ ì£¼ì„¸ìš”."));
    } else {
        alert("ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” ìë™ ë³µì‚¬ê°€ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì§ì ‘ ë³µì‚¬í•´ ì£¼ì„¸ìš”.");
    }
}

/* ì¹´ë“œ ì‚­ì œ */
function deleteSpace(docId) {
    if (!confirm("ì´ ìˆ™ì œ ì¹´ë“œë¥¼ ì‚­ì œí• ê¹Œìš”?\nì™„ì „íˆ ëë‚œ ì¹´ë“œë§Œ ì§€ì›Œ ì£¼ì„¸ìš”!")) return;
    spacesRef.doc(docId).delete()
        .catch(err => {
            console.error(err);
            alert("ì‚­ì œ ì¤‘ ë¬¸ì œê°€ ìƒê²¼ì–´ìš”.");
        });
}

/* ì¹´ìš´íŠ¸ ì§ì ‘ ì…ë ¥ */
function setCount(docId, field, rawValue) {
    let value = parseInt(rawValue, 10);
    if (isNaN(value) || value < 0) value = 0;

    spacesRef.doc(docId).update({
        ["counts." + field]: value
    }).catch(err => {
        console.error(err);
        alert("ìˆ˜ëŸ‰ ì €ì¥ ì¤‘ ë¬¸ì œê°€ ìƒê²¼ì–´ìš”.");
    });
}

/* + / - ë²„íŠ¼ */
function changeCount(docId, field, delta, btn) {
    const container = btn.parentNode;         // .count-controls
    const input = container.querySelector("input");
    let value = parseInt(input.value, 10);
    if (isNaN(value)) value = 0;
    value += delta;
    if (value < 0) value = 0;
    input.value = value;
    setCount(docId, field, value);
}

/* ë©”ëª¨, ë‹‰ë„¤ì„ ìˆ˜ì • */
function updateSpaceField(docId, field, value) {
    spacesRef.doc(docId).update({ [field]: value })
        .catch(err => {
            console.error(err);
            alert("ì €ì¥ ì¤‘ ë¬¸ì œê°€ ìƒê²¼ì–´ìš”.");
        });
}

/* ì¹´ë“œ ë Œë”ë§ */
function renderSpaces() {
    const container = document.getElementById("spacesContainer");
    container.innerHTML = "";

    if (!spacesData.length) {
        container.innerHTML =
            '<div class="helper">ì•„ì§ ë“±ë¡ëœ ìˆ™ì œ ì¹´ë“œê°€ ì—†ìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•´ ì£¼ì„¸ìš”.</div>';
        return;
    }

    spacesData.forEach(item => {
        const card = document.createElement("div");
        card.className = "space-card";

        const counts = item.counts || {};
        const nickname = item.nickname || "";
        const userid   = item.userid || "";
        const memo     = item.memo || "";

        card.innerHTML = `
            <div class="space-header">
                <div class="space-main">
                    <div class="badge-nick">
                        ë‹‰ë„¤ì„:
                        <span class="nick-text">
                            <input type="text"
                                   value="${nickname.replace(/"/g, "&quot;")}"
                                   style="border:none;background:transparent;width:140px;font-size:13px;"
                                   onchange="updateSpaceField('${item.id}','nickname',this.value)" />
                        </span>
                    </div>
                    <div class="badge-id">
                        <span>ì•„ì´ë””: ${userid ? userid.replace(/</g,"&lt;") : ""}</span>
                        <button type="button" class="copy-btn"
                                onclick="copyUserId('${userid.replace(/'/g, "\\'")}')">ë³µì‚¬</button>
                    </div>
                </div>
                <button type="button" class="delete-btn" onclick="deleteSpace('${item.id}')">
                    ì‚­ì œ ğŸ°
                </button>
            </div>

            <div class="count-row">
                ${statNames.map(name => {
                    const v = typeof counts[name] === "number" ? counts[name] : 0;
                    return `
                    <div class="count-chip">
                        <span class="count-label">${name}</span>
                        <div class="count-controls">
                            <button type="button" class="count-btn"
                                onclick="changeCount('${item.id}','${name}',-1,this)">-</button>
                            <input type="number" min="0" value="${v}"
                                onchange="setCount('${item.id}','${name}',this.value)" />
                            <button type="button" class="count-btn"
                                onclick="changeCount('${item.id}','${name}',1,this)">+</button>
                        </div>
                    </div>`;
                }).join("")}
            </div>

            <div class="space-memo">
                <div class="label-line" style="margin-top:4px;">ë©”ëª¨</div>
                <textarea
                    onchange="updateSpaceField('${item.id}','memo',this.value)">${memo.replace(/</g,"&lt;")}</textarea>
            </div>
        `;

        container.appendChild(card);
    });
}

/* ì´ˆê¸° ì„¸íŒ… */
document.addEventListener("DOMContentLoaded", () => {
    setTodayTitle();
});
</script>

</body>
</html>
