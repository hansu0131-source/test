<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ¥• ë‹¹ - ìˆ™ì œ ê´€ë¦¬ì (Final)</title>

<!-- Firebase compat SDK -->
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

<style>
  *{box-sizing:border-box;}

  body{
    background:#FFF5E8;
    font-family:-apple-system,BlinkMacSystemFont,"Pretendard",system-ui,sans-serif;
    margin:0;
    padding:16px;
    color:#4b3525;
    max-width:420px;
    margin-inline:auto;
  }

  h1{
    text-align:center;
    color:#ff8a3c;
    margin:0 0 6px;
    font-size:22px;
  }

  .tag{
    text-align:center;
    font-size:12px;
    color:#fff;
    background:#ffb37a;
    padding:4px 12px;
    border-radius:999px;
    display:inline-block;
    margin-left:50%;
    transform:translateX(-50%);
    margin-bottom:18px;
  }

  .section-title{
    font-size:15px;
    font-weight:700;
    margin-bottom:6px;
    color:#ff8a3c;
    display:flex;
    align-items:center;
    gap:6px;
  }
  .section-title .sub{
    font-size:12px;
    font-weight:400;
    color:#b07b55;
  }

  .card{
    background:#ffffff;
    padding:12px;
    border-radius:14px;
    box-shadow:0 3px 10px rgba(255,150,95,.22);
    margin-bottom:16px;
  }

  .small-helper{
    font-size:11px;
    color:#aa7c5b;
    margin-bottom:6px;
  }

  textarea{
    width:100%;
    min-height:70px;
    border-radius:10px;
    border:1px solid #ffcfac;
    padding:8px;
    resize:vertical;
    font-family:inherit;
    font-size:13px;
    background:#fffdfa;
  }

  button{
    padding:8px 14px;
    border:none;
    border-radius:999px;
    background:#ff8a3c;
    color:#fff;
    font-weight:600;
    cursor:pointer;
    font-size:13px;
  }
  button:active{transform:translateY(1px);}
  .btn-sub{background:#ffd2ae;color:#9f4e23;}
  .btn-danger{background:#ffebe1;color:#ff5c37;}
  .btn-pink{background:#ff6f9f;color:#fff;}

  .input-small-label{
    font-size:12px;
    color:#79533a;
    margin-bottom:4px;
  }

  /* today / backlog 3x3 */
  .stat-grid{
    display:grid;
    grid-template-columns:repeat(3,minmax(0,1fr));
    gap:8px;
    margin-top:6px;
  }
  .stat-item{
    background:#ffe7cf;
    border-radius:12px;
    padding:6px 6px 8px;
    text-align:center;
  }
  .stat-label{
    font-size:12px;
    color:#8f532d;
    margin-bottom:3px;
  }
  .stat-input{
    width:100%;
    padding:4px 0;
    border-radius:999px;
    border:1px solid #ffd1a4;
    background:#fffdfa;
    font-size:13px;
    text-align:center;
  }

  .summary-footer{
    margin-top:8px;
    text-align:right;
  }

  /* add row */
  .input-line{
    display:flex;
    gap:8px;
    margin-top:6px;
  }
  .input-line input[type="text"]{
    flex:1;
    padding:7px;
    border-radius:9px;
    border:1px solid #ffd1a4;
    background:#fffdfa;
    font-size:13px;
    min-width:0;
  }

  /* space cards */
  .space-card{
    margin-bottom:10px;
    padding:10px;
    border-radius:12px;
    background:#fffdf8;
    border:1px solid #ffe4c9;
    box-shadow:0 2px 6px rgba(0,0,0,.03);
  }

  .space-header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:6px;
    margin-bottom:6px;
  }

  .badge-nick{
    font-size:13px;
    font-weight:600;
    padding:4px 10px;
    border-radius:999px;
    background:#ffe0c2;
    color:#8b4b20;
    display:inline-flex;
    align-items:center;
    gap:6px;
  }

  .badge-id{
    font-size:11px;
    padding:4px 8px;
    border-radius:999px;
    background:#fff6eb;
    color:#a85a23;
    display:inline-flex;
    align-items:center;
    gap:4px;
    margin-top:4px;
  }
  .badge-id button{
    padding:2px 6px;
    font-size:10px;
    border-radius:999px;
    background:#ffbf86;
    color:#fff;
  }

  .space-main{
    display:flex;
    flex-direction:column;
  }

  .space-grid{
    display:grid;
    grid-template-columns:repeat(3,minmax(0,1fr));
    gap:8px;
    margin-top:8px;
    margin-bottom:8px;
  }
  .space-stat{
    background:#ffe7cf;
    border-radius:12px;
    padding:6px 6px 8px;
    text-align:center;
  }
  .space-stat-label{
    font-size:12px;
    color:#8f532d;
    margin-bottom:3px;
  }
  .space-stat-input{
    width:100%;
    padding:4px 0;
    border-radius:999px;
    border:1px solid #ffd1a4;
    background:#fffdfa;
    font-size:13px;
    text-align:center;
  }

  .memo-balloon-wrap{
    display:flex;
    gap:8px;
    margin-top:4px;
  }
  .memo-wrap,.balloon-wrap{
    flex:1;
  }
  .memo-label,.balloon-label{
    font-size:12px;
    color:#79533a;
    margin-bottom:4px;
  }
  .memo-textarea,.balloon-textarea{
    width:100%;
    min-height:70px;
    border-radius:10px;
    border:1px solid #ffcfac;
    padding:8px;
    resize:vertical;
    font-family:inherit;
    font-size:13px;
    background:#fffdfa;
  }

  .space-footer{
    display:flex;
    justify-content:flex-end;
    margin-top:8px;
  }

  @media (max-width:360px){
    body{padding-inline:10px;}
  }
</style>
</head>

<body>

<h1>ğŸ¥• ë‹¹ - ìˆ™ì œ ê´€ë¦¬ì</h1>
<div class="tag">ê´€ë¦¬ì ID: ë‹¹ (ì£¼í™©)</div>

<!-- ì˜¤ëŠ˜ì˜ í•œë§ˆë”” -->
<div class="card">
  <div class="section-title">ğŸ“Œ ì˜¤ëŠ˜ì˜ í•œë§ˆë”” <span class="sub">(ê´€ë¦¬ì â†” ì‚¬ìš©ì)</span></div>

  <div class="input-small-label">ğŸ¥• ê´€ë¦¬ì â†’ ì‚¬ìš©ì</div>
  <textarea id="adminMessage" placeholder="ë‚­ì—ê²Œ ì˜¤ëŠ˜ ì „í•˜ê³  ì‹¶ì€ ë§"></textarea>
  <div style="margin-top:6px; text-align:right;">
    <button onclick="saveAdminMessage()">ê´€ë¦¬ì í•œë§ˆë”” ì €ì¥</button>
  </div>

  <div style="height:10px;"></div>

  <div class="input-small-label">ğŸ° ì‚¬ìš©ì â†’ ê´€ë¦¬ì</div>
  <div id="userMessageBox"
       style="white-space:pre-line;padding:8px;border-radius:10px;border:1px solid #ffd7c2;background:#fff8f3;font-size:13px;">
    (ì•„ì§ ì‚¬ìš©ì ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤)
  </div>
</div>

<!-- ì˜¤ëŠ˜ ìˆ™ì œ -->
<div class="card">
  <div class="section-title" id="todayTitle">ğŸ“¦ ì˜¤ëŠ˜ ìˆ™ì œ</div>
  <div class="small-helper">â€» ì˜¤ëŠ˜ í•´ì•¼ í•  ìˆ™ì œ ìˆ«ìë¥¼ ì ì–´ ì£¼ì„¸ìš”. í•©ê³„(ë°°+ì—­, ì›€+ì‚¬)ëŠ” ì €ì¥ ì‹œ ìë™ ê³„ì‚°ë©ë‹ˆë‹¤.</div>

  <div class="stat-grid" id="todayGrid">
    <!-- JSì—ì„œ ì±„ì›€ -->
  </div>

  <div class="summary-footer">
    <button class="btn-sub" onclick="saveSummary('today')">ì˜¤ëŠ˜ ìˆ™ì œ ì €ì¥</button>
  </div>
</div>

<!-- ë°€ë¦° ìˆ™ì œ -->
<div class="card">
  <div class="section-title">ğŸ“¦ ë°€ë¦° ìˆ™ì œ</div>
  <div class="small-helper">ë°€ë ¤ ìˆëŠ” ìˆ™ì œ ìˆ«ìë¥¼ ì ì–´ ì£¼ì„¸ìš”. í•©ê³„(ë°°+ì—­, ì›€+ì‚¬)ëŠ” ì €ì¥ ì‹œ ìë™ ê³„ì‚°ë©ë‹ˆë‹¤.</div>

  <div class="stat-grid" id="backlogGrid">
    <!-- JSì—ì„œ ì±„ì›€ -->
  </div>

  <div class="summary-footer">
    <button class="btn-sub" onclick="saveSummary('backlog')">ë°€ë¦° ìˆ™ì œ ì €ì¥</button>
  </div>
</div>

<!-- ìˆ™ì œ ëŒ€ìƒ ì¶”ê°€ -->
<div class="card">
  <div class="section-title">ğŸ“‹ ìˆ™ì œ ëŒ€ìƒ ì¶”ê°€</div>
  <div class="input-small-label">ë‹‰ë„¤ì„ / ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ê³  í–‰ì„ ì¶”ê°€í•˜ì„¸ìš”.</div>
  <div class="input-line">
    <input type="text" id="newNick" placeholder="ë‹‰ë„¤ì„">
    <input type="text" id="newID" placeholder="ì•„ì´ë””">
    <button onclick="addSpace()">ì¶”ê°€</button>
  </div>
</div>

<!-- ìˆ™ì œ ì¹´ë“œ ëª©ë¡ -->
<div class="card">
  <div class="section-title">ğŸ“„ ìˆ™ì œ ì¹´ë“œ</div>
  <div class="small-helper">
    ê´€ë¦¬ìê°€ ë§Œë“¤ì–´ ì¤€ ì¹´ë“œì…ë‹ˆë‹¤. ê° í•­ëª©ì˜ ìˆ«ìì™€ ë©”ëª¨, í’ì„  ë‚´ìš©ì„ ì±„ìš´ ë’¤ ëª¨ë‘ ëë‚œ ì¹´ë“œëŠ”
    <b>ì™„ë£Œ ğŸ°</b> ë²„íŠ¼ì„ ëˆŒëŸ¬ì„œ ì •ë¦¬í•´ ì£¼ì„¸ìš”.
  </div>
  <div id="spacesContainer"></div>
</div>

<script>
  /* Firebase ì´ˆê¸°í™” */
  const firebaseConfig = {
    apiKey:"AIzaSyAHmLNi5VOuAE-gXnAg-fEfzylPZvzvfVo",
    authDomain:"daily-checklist-91e5a.firebaseapp.com",
    projectId:"daily-checklist-91e5a",
    storageBucket:"daily-checklist-91e5a.firebasestorage.app",
    messagingSenderId:"66394691958",
    appId:"1:66394691958:web:cf91f295456a2e10d18257",
    measurementId:"G-87WK4N4EGH"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const todayMessagesRef = db.collection("today").doc("messages");
  const summaryTodayRef  = db.collection("summary").doc("today");
  const summaryBacklogRef= db.collection("summary").doc("backlog");
  const spacesRef        = db.collection("spaces");

  // today/backlog í•„ë“œ ì •ì˜
  const STAT_FIELDS = [
    {key:"baemin", label:"ë°°ë¯¼"},
    {key:"bangsel", label:"ë°©ì…€"},
    {key:"umjjal", label:"ì›€ì§¤"},
    {key:"yeok", label:"ì—­íŒ¬"},
    {key:"jeong", label:"ì •ì„±"},
    {key:"photo", label:"ì‚¬ì§„"},
    {key:"sum_baeyeok", label:"í•©ê³„(ë°°+ì—­)"},
    {key:"video", label:"ì˜ìƒ"},
    {key:"sum_umsa", label:"í•©ê³„(ì›€+ì‚¬)"}
  ];

  function buildStatGrid(containerId, prefix){
    const container = document.getElementById(containerId);
    container.innerHTML = "";
    STAT_FIELDS.forEach(f=>{
      const wrap = document.createElement("div");
      wrap.className = "stat-item";
      wrap.innerHTML = `
        <div class="stat-label">${f.label}</div>
        <input type="number" min="0" value="0"
               id="${prefix}-${f.key}" class="stat-input">
      `;
      container.appendChild(wrap);
    });
  }

  buildStatGrid("todayGrid","today");
  buildStatGrid("backlogGrid","backlog");

  // ì˜¤ëŠ˜ ë‚ ì§œ íƒ€ì´í‹€
  function setTodayTitle(){
    const now = new Date();
    const m = now.getMonth()+1;
    const d = now.getDate();
    const weekday = ["ì¼","ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ","í† "][now.getDay()];
    document.getElementById("todayTitle").textContent =
      `ğŸ“¦ ${m}ì›” ${d}ì¼(${weekday}) ìˆ™ì œ`;
  }
  setTodayTitle();

  /* ì˜¤ëŠ˜ì˜ í•œë§ˆë”” ì‹¤ì‹œê°„ */
  todayMessagesRef.onSnapshot(doc=>{
    if(!doc.exists){
      todayMessagesRef.set({
        adminMessage:"",
        userMessage:"",
        date:new Date().toISOString()
      },{merge:true});
      return;
    }
    const data = doc.data();
    document.getElementById("adminMessage").value = data.adminMessage || "";
    document.getElementById("userMessageBox").innerText =
      data.userMessage || "(ì•„ì§ ì‚¬ìš©ì ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤)";
  });

  function saveAdminMessage(){
    const msg = document.getElementById("adminMessage").value;
    todayMessagesRef.set({
      adminMessage:msg,
      date:new Date().toISOString()
    },{merge:true})
    .then(()=>alert("ê´€ë¦¬ì í•œë§ˆë””ë¥¼ ì €ì¥í–ˆì–´ìš”."))
    .catch(e=>{console.error(e);alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.");});
  }

  /* ìš”ì•½ ì‹¤ì‹œê°„ ë¡œë“œ */
  function bindSummarySnapshot(ref,prefix){
    ref.onSnapshot(doc=>{
      const data = doc.exists ? doc.data() : {};
      STAT_FIELDS.forEach(f=>{
        const el = document.getElementById(prefix+"-"+f.key);
        if(el) el.value = data[f.key] ?? 0;
      });
    });
  }
  bindSummarySnapshot(summaryTodayRef,"today");
  bindSummarySnapshot(summaryBacklogRef,"backlog");

  /* ìš”ì•½ ì €ì¥ (ìë™ í•©ê³„) */
  function collectSummary(prefix){
    const result = {};
    STAT_FIELDS.forEach(f=>{
      const el = document.getElementById(prefix+"-"+f.key);
      result[f.key] = Number(el.value || 0);
    });
    // ìë™ í•©ê³„ ê³„ì‚°
    result.sum_baeyeok = (result.baemin||0) + (result.yeok||0);
    result.sum_umsa    = (result.umjjal||0) + (result.photo||0);
    return result;
  }

  function saveSummary(which){
    const ref = which==="today" ? summaryTodayRef : summaryBacklogRef;
    const prefix = which;
    const payload = collectSummary(prefix);
    payload.updatedAt = new Date();

    // í™”ë©´ì—ë„ í•©ê³„ ë°˜ì˜
    document.getElementById(prefix+"-sum_baeyeok").value = payload.sum_baeyeok;
    document.getElementById(prefix+"-sum_umsa").value    = payload.sum_umsa;

    ref.set(payload,{merge:true})
      .then(()=>alert(which==="today"?"ì˜¤ëŠ˜ ìˆ™ì œë¥¼ ì €ì¥í–ˆì–´ìš”.":"ë°€ë¦° ìˆ™ì œë¥¼ ì €ì¥í–ˆì–´ìš”."))
      .catch(e=>{console.error(e);alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.");});
  }

  /* ìƒˆ space ì¶”ê°€ */
  function addSpace(){
    const nickEl = document.getElementById("newNick");
    const idEl   = document.getElementById("newID");
    const nickname = nickEl.value.trim();
    const userid   = idEl.value.trim();
    if(!nickname || !userid){
      alert("ë‹‰ë„¤ì„ê³¼ ì•„ì´ë””ë¥¼ ëª¨ë‘ ì…ë ¥í•´ ì£¼ì„¸ìš”.");
      return;
    }

    spacesRef.add({
      nickname,
      userid,
      memo:"",
      balloon:"",
      "ì—­íŒ¬":0,
      "ë°°ë¯¼":0,
      "ì •ì„±":0,
      "ì˜ìƒ":0,
      "ë°©ì…€":0
    }).then(()=>{
      nickEl.value=""; idEl.value="";
    }).catch(err=>{
      console.error(err);
      alert("í–‰ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.");
    });
  }

  function copyUserId(value){
    if(!value) return;
    if(navigator.clipboard && navigator.clipboard.writeText){
      navigator.clipboard.writeText(value)
        .then(()=>alert("ì•„ì´ë””ë¥¼ ë³µì‚¬í–ˆì–´ìš”: "+value))
        .catch(()=>alert("ë³µì‚¬ ì¤‘ ë¬¸ì œê°€ ìƒê²¼ì–´ìš”. ì§ì ‘ ë³µì‚¬í•´ ì£¼ì„¸ìš”."));
    }else{
      alert("ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” ìë™ ë³µì‚¬ê°€ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì§ì ‘ ë³µì‚¬í•´ ì£¼ì„¸ìš”.");
    }
  }

  function updateSpaceNumber(docId, field, value){
    spacesRef.doc(docId).update({ [field]:Number(value)||0 })
      .catch(err=>{console.error(err);alert("ìˆ«ì ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.");});
  }

  function updateSpaceField(docId, field, value){
    spacesRef.doc(docId).update({ [field]:value })
      .catch(err=>{console.error(err);alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.");});
  }

  function completeSpace(docId){
    if(!confirm("ì´ ì¹´ë“œì˜ ìˆ™ì œë¥¼ ëª¨ë‘ ì™„ë£Œí–ˆë‚˜ìš”?\nì™„ë£Œí•˜ë©´ ì¹´ë“œê°€ ëª©ë¡ì—ì„œ ì‚¬ë¼ì ¸ìš”.")) return;
    spacesRef.doc(docId).delete()
      .catch(err=>{console.error(err);alert("ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.");});
  }

  spacesRef.onSnapshot(snapshot=>{
    const data = snapshot.docs.map(d=>({id:d.id,...d.data()}));
    renderSpaces(data);
  });

  function renderSpaces(list){
    const container = document.getElementById("spacesContainer");
    container.innerHTML = "";
    if(!list.length){
      container.innerHTML = '<div class="small-helper">ì•„ì§ ì¶”ê°€ëœ ìˆ™ì œ ì¹´ë“œê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
      return;
    }

    list.forEach(item=>{
      const card = document.createElement("div");
      card.className = "space-card";

      const counts = {
        "ì—­íŒ¬":item["ì—­íŒ¬"] ?? 0,
        "ë°°ë¯¼":item["ë°°ë¯¼"] ?? 0,
        "ì •ì„±":item["ì •ì„±"] ?? 0,
        "ì˜ìƒ":item["ì˜ìƒ"] ?? 0,
        "ë°©ì…€":item["ë°©ì…€"] ?? 0
      };

      card.innerHTML = `
        <div class="space-header">
          <div class="space-main">
            <div class="badge-nick">
              ë‹‰ë„¤ì„:
              <input type="text"
                     value="${item.nickname||""}"
                     style="border:none;background:transparent;width:150px;font-size:13px;"
                     onchange="updateSpaceField('${item.id}','nickname',this.value)">
            </div>
            <div class="badge-id">
              <span>ì•„ì´ë””: ${item.userid||""}</span>
              <button type="button" onclick="copyUserId('${item.userid||""}')">ë³µì‚¬</button>
            </div>
          </div>
          <button class="btn-pink" type="button" onclick="completeSpace('${item.id}')">
            ì™„ë£Œ ğŸ°
          </button>
        </div>

        <div class="space-grid">
          ${["ì—­íŒ¬","ë°°ë¯¼","ì •ì„±","ì˜ìƒ","ë°©ì…€"].map(label=>`
            <div class="space-stat">
              <div class="space-stat-label">${label}</div>
              <input type="number" min="0" value="${counts[label]}"
                     class="space-stat-input"
                     onchange="updateSpaceNumber('${item.id}','${label}',this.value)">
            </div>
          `).join("")}
        </div>

        <div class="memo-balloon-wrap">
          <div class="memo-wrap">
            <div class="memo-label">ë©”ëª¨</div>
            <textarea class="memo-textarea"
                      onchange="updateSpaceField('${item.id}','memo',this.value)">${item.memo||""}</textarea>
          </div>
          <div class="balloon-wrap">
            <div class="balloon-label">í’ì„ </div>
            <textarea class="balloon-textarea"
                      onchange="updateSpaceField('${item.id}','balloon',this.value)">${item.balloon||""}</textarea>
          </div>
        </div>
      `;
      container.appendChild(card);
    });
  }
</script>

</body>
</html>
