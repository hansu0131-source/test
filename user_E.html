<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ° ë‚­ - ìˆ™ì œ ì²´í¬ (C ìŠ¤íƒ€ì¼ ìµœì¢…)</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

<style>
    * { box-sizing:border-box; }

    body {
        background:#ffe3f1;
        font-family:-apple-system, BlinkMacSystemFont, "Pretendard", system-ui;
        padding:16px; margin:0;
        color:#552642;
    }

    h1 {
        text-align:center;
        color:#ff6aaa;
        font-size:22px;
        margin:0 0 6px 0;
    }

    .tag {
        display:block;
        text-align:center;
        background:#ff98c7;
        color:white;
        padding:4px 12px;
        border-radius:999px;
        font-size:12px;
        width:max-content;
        margin:0 auto 18px auto;
    }

    .card {
        background:white;
        border-radius:14px;
        padding:14px;
        margin-bottom:18px;
        box-shadow:0 3px 12px rgba(255,140,170,0.25);
    }

    .section-title {
        font-size:15px;
        font-weight:700;
        color:#ff6aaa;
        display:flex;
        align-items:center;
        gap:6px;
        margin-bottom:10px;
    }

    .label-line {
        font-size:13px;
        color:#8b4b6f;
        margin-bottom:4px;
    }

    textarea {
        width:100%;
        min-height:70px;
        border-radius:10px;
        border:1px solid #ffc7df;
        padding:8px;
        font-size:13px;
        background:#fff7fb;
        resize:vertical;
        font-family:inherit;
    }

    button {
        padding:8px 14px;
        background:#ff6aaa;
        color:white; font-weight:600;
        border:none; border-radius:999px;
        cursor:pointer; font-size:13px;
    }
    button:active { transform:translateY(1px); }

    /* ğŸ“¦ ìš”ì•½ í…Œì´ë¸” (ì½ê¸°ì „ìš©) */
    .summary-table {
        width:100%;
        border-collapse:collapse;
        margin-top:4px;
        font-size:12px;
    }
    .summary-table td {
        border:1px solid #ffd4ec;
        padding:4px 6px;
        text-align:center;
        vertical-align:middle;
    }
    .summary-cell {
        background:#fff4fb;
        border-radius:10px;
    }
    .summary-cell-inner {
        display:flex;
        flex-direction:column;
        align-items:center;
        justify-content:center;
        gap:2px;
    }
    .summary-label {
        font-size:12px;
        color:#a23f73;
        font-weight:600;
    }
    .summary-value {
        font-size:14px;
        color:#ff4b8a;
        font-weight:700;
    }
    .summary-empty {
        background:transparent;
        border:none;
    }

    /* ìˆ™ì œ ì¹´ë“œ */
    .space-card {
        background:#fffafd;
        border:1px solid #ffd6ea;
        border-radius:12px;
        padding:12px;
        margin-bottom:14px;
        box-shadow:0 2px 8px rgba(255,140,190,0.18);
    }

    .space-header {
        display:flex;
        justify-content:space-between;
        align-items:center;
        gap:6px;
        margin-bottom:8px;
    }

    .space-main {
        display:flex;
        flex-direction:column;
        gap:4px;
    }

    .badge-nick {
        background:#ffd8ea;
        padding:4px 10px;
        border-radius:999px;
        font-size:13px;
        font-weight:600;
        color:#8b2f5f;
    }

    .badge-id {
        background:#fff2fa;
        padding:4px 8px;
        border-radius:999px;
        font-size:11px;
        color:#a33f72;
        display:inline-flex;
        align-items:center;
        gap:4px;
    }
    .badge-id button {
        padding:2px 6px;
        background:#ff96c4;
        font-size:11px;
        border-radius:999px;
        color:white;
    }

    .complete-btn {
        padding:6px 12px;
        font-size:11px;
        border-radius:999px;
        background:#ffd0e4;
        color:#b4437c;
    }

    .count-row {
        display:flex;
        flex-wrap:wrap;
        gap:6px;
        margin-bottom:6px;
    }

    .count-chip {
        display:inline-flex;
        align-items:center;
        gap:6px;
        padding:4px 8px;
        border-radius:999px;
        background:#ffe8f3;
        border:1px solid #ffd2e9;
        font-size:11px;
        color:#8c3e6d;
    }

    .count-label {
        min-width:32px;
    }

    .count-input {
        width:45px;
        padding:3px 0;
        border-radius:8px;
        border:1px solid #ffc7df;
        background:#fff7fb;
        text-align:center;
        font-size:11px;
    }

    .memo-balloon-row {
        display:flex;
        flex-wrap:wrap;
        gap:8px;
        margin-top:4px;
    }

    .memo-block {
        flex:1 1 60%;
    }

    .balloon-block {
        flex:0 0 90px;
    }

    .small-label {
        font-size:12px;
        color:#8b4b6f;
        margin-bottom:4px;
    }

    .balloon-input {
        width:100%;
        padding:6px;
        border-radius:9px;
        border:1px solid #ffc7df;
        background:#fff7fb;
        text-align:center;
        font-size:12px;
    }

    .tasks-note {
        font-size:11px;
        color:#a86b8a;
        margin-bottom:4px;
    }

    @media (min-width:720px){
        body{ max-width:640px; margin:0 auto; }
    }
</style>
</head>

<body>

<h1>ğŸ° ë‚­ - ìˆ™ì œ ì²´í¬</h1>
<div class="tag">ì‚¬ìš©ì ID: ë‚­ (í•‘í¬)</div>

<!-- ì˜¤ëŠ˜ì˜ í•œë§ˆë”” -->
<div class="card">
    <div class="section-title">ğŸ“Œ ì˜¤ëŠ˜ì˜ í•œë§ˆë””</div>

    <div class="label-line">ğŸ¥• ê´€ë¦¬ì â†’ ë‚­</div>
    <div id="adminMessageBox"
         style="white-space:pre-line; padding:8px; background:#fff8fb; border-radius:10px; border:1px solid #ffd7e8; font-size:13px;">
        (ê´€ë¦¬ìê°€ ì•„ì§ ë©”ì‹œì§€ë¥¼ ë‚¨ê¸°ì§€ ì•Šì•˜ì–´ìš”)
    </div>

    <div style="height:8px;"></div>

    <div class="label-line">ğŸ° ë‚­ â†’ ê´€ë¦¬ì</div>
    <textarea id="userMessage" placeholder="ì˜¤ëŠ˜ í•˜ê³  ì‹¶ì€ ë§ ì ì–´ì£¼ì„¸ìš”"></textarea>
    <div style="text-align:right; margin-top:6px;">
        <button onclick="saveUserMessage()">ì €ì¥</button>
    </div>
</div>

<!-- ì˜¤ëŠ˜ ìˆ™ì œ -->
<div class="card">
    <div class="section-title">
        ğŸ“¦ <span id="todayTitleText"></span>
    </div>

    <table class="summary-table">
        <tr>
            <td class="summary-cell">
                <div class="summary-cell-inner">
                    <div class="summary-label">ë°°ë¯¼</div>
                    <div class="summary-value" id="today-ë°°ë¯¼">0</div>
                </div>
            </td>
            <td class="summary-empty"></td>
            <td class="summary-cell">
                <div class="summary-cell-inner">
                    <div class="summary-label">ì—­íŒ¬</div>
                    <div class="summary-value" id="today-ì—­íŒ¬">0</div>
                </div>
            </td>
        </tr>
        <tr>
            <td class="summary-cell">
                <div class="summary-cell-inner">
                    <div class="summary-label">ë°©ì…€</div>
                    <div class="summary-value" id="today-ë°©ì…€">0</div>
                </div>
            </td>
            <td class="summary-cell">
                <div class="summary-cell-inner">
                    <div class="summary-label">ì •ì„±</div>
                    <div class="summary-value" id="today-ì •ì„±">0</div>
                </div>
            </td>
            <td class="summary-cell">
                <div class="summary-cell-inner">
                    <div class="summary-label">ì˜ìƒ</div>
                    <div class="summary-value" id="today-ì˜ìƒ">0</div>
                </div>
            </td>
        </tr>
        <tr>
            <td class="summary-cell">
                <div class="summary-cell-inner">
                    <div class="summary-label">ìˆ™ì œ</div>
                    <div class="summary-value" id="today-ìˆ™ì œ">0</div>
                </div>
            </td>
            <td class="summary-cell">
                <div class="summary-cell-inner">
                    <div class="summary-label">ì›€ì§¤</div>
                    <div class="summary-value" id="today-ì›€ì§¤">0</div>
                </div>
            </td>
            <td class="summary-cell">
                <div class="summary-cell-inner">
                    <div class="summary-label">ì‚¬ì§„</div>
                    <div class="summary-value" id="today-ì‚¬ì§„">0</div>
                </div>
            </td>
        </tr>
    </table>
</div>

<!-- ë°€ë¦° ìˆ™ì œ -->
<div class="card">
    <div class="section-title">ğŸ“¦ ë°€ë¦° ìˆ™ì œ</div>

    <table class="summary-table">
        <tr>
            <td class="summary-cell">
                <div class="summary-cell-inner">
                    <div class="summary-label">ë°°ë¯¼</div>
                    <div class="summary-value" id="total-ë°°ë¯¼">0</div>
                </div>
            </td>
            <td class="summary-empty"></td>
            <td class="summary-cell">
                <div class="summary-cell-inner">
                    <div class="summary-label">ì—­íŒ¬</div>
                    <div class="summary-value" id="total-ì—­íŒ¬">0</div>
                </div>
            </td>
        </tr>
        <tr>
            <td class="summary-cell">
                <div class="summary-cell-inner">
                    <div class="summary-label">ë°©ì…€</div>
                    <div class="summary-value" id="total-ë°©ì…€">0</div>
                </div>
            </td>
            <td class="summary-cell">
                <div class="summary-cell-inner">
                    <div class="summary-label">ì •ì„±</div>
                    <div class="summary-value" id="total-ì •ì„±">0</div>
                </div>
            </td>
            <td class="summary-cell">
                <div class="summary-cell-inner">
                    <div class="summary-label">ì˜ìƒ</div>
                    <div class="summary-value" id="total-ì˜ìƒ">0</div>
                </div>
            </td>
        </tr>
        <tr>
            <td class="summary-cell">
                <div class="summary-cell-inner">
                    <div class="summary-label">ìˆ™ì œ</div>
                    <div class="summary-value" id="total-ìˆ™ì œ">0</div>
                </div>
            </td>
            <td class="summary-cell">
                <div class="summary-cell-inner">
                    <div class="summary-label">ì›€ì§¤</div>
                    <div class="summary-value" id="total-ì›€ì§¤">0</div>
                </div>
            </td>
            <td class="summary-cell">
                <div class="summary-cell-inner">
                    <div class="summary-label">ì‚¬ì§„</div>
                    <div class="summary-value" id="total-ì‚¬ì§„">0</div>
                </div>
            </td>
        </tr>
    </table>
</div>

<!-- ìˆ™ì œ ì¹´ë“œ -->
<div class="card">
    <div class="section-title">ğŸ“‹ ìˆ™ì œ ì¹´ë“œ</div>
    <div class="tasks-note">
        ê´€ë¦¬ìê°€ ë„£ì–´ì¤€ í•­ëª©ì— ëŒ€í•´ <b>ìˆ«ì</b>ë¡œ ìˆ˜ëŸ‰ì„ ì ì–´ì£¼ì„¸ìš”.<br>
        ì¹´ë“œ í•˜ë‚˜ê°€ ë‹¤ ëë‚¬ë‹¤ë©´ ì˜¤ë¥¸ìª½ì˜ <b>ì™„ë£Œ</b> ë²„íŠ¼ìœ¼ë¡œ ì •ë¦¬í•  ìˆ˜ ìˆì–´ìš” ğŸ°
    </div>
    <div id="spacesContainer"></div>
</div>

<script>
/* Firebase ì´ˆê¸°í™” */
firebase.initializeApp({
    apiKey:"AIzaSyAHmLNi5VOuAE-gXnAg-fEfzylPZvzvfVo",
    authDomain:"daily-checklist-91e5a.firebaseapp.com",
    projectId:"daily-checklist-91e5a",
    storageBucket:"daily-checklist-91e5a.firebasestorage.app",
    messagingSenderId:"66394691958",
    appId:"1:66394691958:web:cf91f295456a2e10d18257"
});
const db=firebase.firestore();

const todayMessagesRef=db.collection("today").doc("messages");
const summaryTodayRef=db.collection("summary").doc("today");
const summaryTotalRef=db.collection("summary").doc("total");
const configRef=db.collection("config").doc("checklist");
const spacesRef=db.collection("spaces");

const statNames=["ë°°ë¯¼","ì—­íŒ¬","ë°©ì…€","ì •ì„±","ì˜ìƒ","ìˆ™ì œ","ì›€ì§¤","ì‚¬ì§„"];
let fields=[];
let spacesData=[];

/* ì˜¤ëŠ˜ ì œëª© */
function setTodayTitle(){
    const now=new Date();
    const m=now.getMonth()+1;
    const d=now.getDate();
    const w=["ì¼","ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ","í† "][now.getDay()];
    document.getElementById("todayTitleText").innerText=`${m}ì›” ${d}ì¼(${w}) ìˆ™ì œ`;
}

/* ê´€ë¦¬ì â†’ ì‚¬ìš©ì / ì‚¬ìš©ì â†’ ê´€ë¦¬ì */
todayMessagesRef.onSnapshot(doc=>{
    if(!doc.exists) return;
    const d=doc.data()||{};
    document.getElementById("adminMessageBox").innerText=
        d.adminMessage || "(ê´€ë¦¬ìê°€ ì•„ì§ ë©”ì‹œì§€ë¥¼ ë‚¨ê¸°ì§€ ì•Šì•˜ì–´ìš”)";
    document.getElementById("userMessage").value=
        d.userMessage || "";
});

function saveUserMessage(){
    const msg=document.getElementById("userMessage").value || "";
    todayMessagesRef.set({
        userMessage:msg,
        date:new Date().toISOString()
    },{merge:true}).then(()=>{
        alert("ì €ì¥í–ˆì–´ìš” ğŸ°");
    }).catch(e=>{
        console.error(e);
        alert("ì €ì¥ ì¤‘ ë¬¸ì œê°€ ìƒê²¼ì–´ìš”.");
    });
}

/* ìš”ì•½ today/total */
summaryTodayRef.onSnapshot(doc=>{
    if(!doc.exists) return;
    const d=doc.data()||{};
    statNames.forEach(n=>{
        const el=document.getElementById("today-"+n);
        if(el) el.innerText=d[n] ?? 0;
    });
});

summaryTotalRef.onSnapshot(doc=>{
    if(!doc.exists) return;
    const d=doc.data()||{};
    statNames.forEach(n=>{
        const el=document.getElementById("total-"+n);
        if(el) el.innerText=d[n] ?? 0;
    });
});

/* í•­ëª© ë¦¬ìŠ¤íŠ¸ (ì¹´ë“œì— ë³´ì—¬ì¤„ í•„ë“œ) */
configRef.onSnapshot(doc=>{
    if(doc.exists) fields=doc.data().fields || [];
    renderSpaces();
});

/* spaces */
spacesRef.onSnapshot(ss=>{
    spacesData=ss.docs.map(d=>({id:d.id,...d.data()}));
    renderSpaces();
});

/* ìœ í‹¸ */
function copyUserId(v){
    if(!v) return;
    if(navigator.clipboard && navigator.clipboard.writeText){
        navigator.clipboard.writeText(v).then(()=>alert("ë³µì‚¬ë¨: "+v));
    }else{
        alert("ë³µì‚¬ ê¸°ëŠ¥ì´ ì§€ì›ë˜ì§€ ì•Šì•„ìš”. ì§ì ‘ ë³µì‚¬í•´ì£¼ì„¸ìš”.");
    }
}

function setCount(id,f,val){
    let num=parseInt(val,10);
    if(isNaN(num) || num<0) num=0;
    spacesRef.doc(id).update({["counts."+f]:num});
}

function updateMemo(id,val){
    spacesRef.doc(id).update({memo:val});
}

function updateBalloon(id,val){
    let num=parseInt(val,10);
    if(isNaN(num) || num<0) num=0;
    spacesRef.doc(id).update({balloon:num});
}

function completeSpace(id){
    if(!confirm("ì •ë§ ì´ ìˆ™ì œë¥¼ ëª¨ë‘ ì™„ë£Œí–ˆë‚˜ìš”?\ní™•ì¸ì„ ëˆ„ë¥´ë©´ ì¹´ë“œê°€ ì‚­ì œë¼ìš”.")) return;
    spacesRef.doc(id).delete().catch(e=>{
        console.error(e);
        alert("ì‚­ì œ ì¤‘ ë¬¸ì œê°€ ìƒê²¼ì–´ìš”.");
    });
}

/* ë Œë” */
function renderSpaces(){
    const box=document.getElementById("spacesContainer");
    box.innerHTML="";

    if(!spacesData.length){
        box.innerHTML='<div style="font-size:12px;color:#a86b8a;">ë“±ë¡ëœ ìˆ™ì œ ì¹´ë“œê°€ ì—†ì–´ìš”. ê´€ë¦¬ìì—ê²Œ í™•ì¸í•´ ì£¼ì„¸ìš”.</div>';
        return;
    }

    spacesData.forEach(item=>{
        const counts=item.counts || {};
        const balloon=item.balloon ?? 0;

        const card=document.createElement("div");
        card.className="space-card";

        const safeNick=(item.nickname||"").replace(/"/g,"&quot;");
        const safeUser=(item.userid||"").replace(/</g,"&lt;");
        const safeMemo=(item.memo||"").replace(/</g,"&lt;");

        const list=(fields && fields.length ? fields : statNames);
        const chips=list.map(name=>{
            const v=(typeof counts[name]==="number") ? counts[name] : 0;
            return `
                <div class="count-chip">
                    <span class="count-label">${name}</span>
                    <input type="number" min="0" class="count-input"
                           value="${v}"
                           onchange="setCount('${item.id}','${name}',this.value)">
                </div>`;
        }).join("");

        card.innerHTML=`
            <div class="space-header">
                <div class="space-main">
                    <div class="badge-nick">
                        ë‹‰ë„¤ì„:
                        <input type="text"
                               value="${safeNick}"
                               style="border:none;background:transparent;width:140px;font-size:13px;"
                               onchange="spacesRef.doc('${item.id}').update({nickname:this.value})">
                    </div>
                    <div class="badge-id">
                        <span>ì•„ì´ë””: ${safeUser}</span>
                        <button type="button" onclick="copyUserId('${(item.userid||"").replace(/'/g,"\\'")}')">ë³µì‚¬</button>
                    </div>
                </div>
                <button type="button" class="complete-btn" onclick="completeSpace('${item.id}')">
                    ì™„ë£Œ
                </button>
            </div>

            <div class="count-row">
                ${chips}
            </div>

            <div class="memo-balloon-row">
                <div class="memo-block">
                    <div class="small-label">ë©”ëª¨</div>
                    <textarea onchange="updateMemo('${item.id}',this.value)">${safeMemo}</textarea>
                </div>
                <div class="balloon-block">
                    <div class="small-label">í’ì„ </div>
                    <input type="number" min="0" class="balloon-input"
                           value="${balloon}"
                           onchange="updateBalloon('${item.id}',this.value)">
                </div>
            </div>
        `;

        box.appendChild(card);
    });
}

/* ì´ˆê¸° */
document.addEventListener("DOMContentLoaded",()=>{ setTodayTitle(); });
</script>

</body>
</html>
