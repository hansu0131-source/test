<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ¥• ë‹¹ - ìˆ™ì œ ê´€ë¦¬ì</title>

<!-- Firebase compat SDK -->
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

<style>
    * { box-sizing: border-box; }

    body {
        background: #FFF5E8;
        font-family: -apple-system, BlinkMacSystemFont, "Pretendard", system-ui, sans-serif;
        margin: 0;
        padding: 16px;
        color: #4b3525;
    }

    h1 {
        text-align: center;
        color: #ff8a3c;
        margin: 0 0 6px 0;
        font-size: 22px;
    }

    .tag {
        text-align: center;
        font-size: 12px;
        color: #fff;
        background: #ffb37a;
        padding: 4px 12px;
        border-radius: 999px;
        display: inline-block;
        margin-left: 50%;
        transform: translateX(-50%);
        margin-bottom: 18px;
    }

    .card {
        background: #ffffff;
        padding: 12px;
        border-radius: 14px;
        box-shadow: 0 3px 10px rgba(255,150,95,0.22);
        margin-bottom: 16px;
    }

    .section-title {
        font-size: 15px;
        font-weight: 700;
        margin-bottom: 8px;
        color: #ff8a3c;
        display: flex;
        align-items: center;
        gap: 6px;
    }
    .section-title span.sub {
        font-size: 12px;
        font-weight: 400;
        color: #b07b55;
    }

    .label-line {
        font-size: 13px;
        color: #79533a;
        margin-bottom: 4px;
    }

    textarea {
        width: 100%;
        min-height: 70px;
        border-radius: 10px;
        border: 1px solid #ffcfac;
        padding: 8px;
        resize: vertical;
        font-family: inherit;
        font-size: 13px;
        background: #fffdfa;
    }

    button {
        padding: 8px 14px;
        border: none;
        border-radius: 999px;
        background: #ff8a3c;
        color: white;
        font-weight: 600;
        cursor: pointer;
        font-size: 13px;
    }
    button:active { transform: translateY(1px); }

    .btn-sub {
        background: #ffd2ae;
        color: #9f4e23;
    }

    .btn-danger {
        background: #ffebe1;
        color: #ff5c37;
    }

    .small-helper {
        font-size: 11px;
        color: #aa7c5b;
        margin-top: 4px;
    }

    /* ğŸ“¦ ìš”ì•½ í…Œì´ë¸” (ë°°ë¯¼/ì—­íŒ¬/ë°©ì…€/ì •ì„±/ì˜ìƒ/ìˆ™ì œ/ì›€ì§¤/ì‚¬ì§„) */
    .summary-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 4px;
        font-size: 12px;
    }
    .summary-table td {
        border: 1px solid #ffe0c6;
        padding: 4px 6px;
        text-align: center;
        vertical-align: middle;
    }
    .summary-cell {
        background: #fff7ec;
        border-radius: 10px;
    }
    .summary-cell-inner {
        display: flex;
        flex-direction: column;
        gap: 2px;
        align-items: center;
        justify-content: center;
    }
    .summary-label {
        font-size: 12px;
        color: #8f532d;
        font-weight: 600;
    }
    .summary-value {
        font-size: 14px;
        color: #d85f1f;
        font-weight: 700;
    }
    .summary-input {
        width: 60px;
        padding: 3px;
        border-radius: 8px;
        border: 1px solid #ffd1a4;
        text-align: center;
        font-size: 12px;
        background: #fffaf4;
    }
    .summary-empty {
        background: transparent;
        border: none;
    }

    /* í•­ëª© pill */
    .pill {
        display: inline-flex;
        align-items: center;
        padding: 4px 10px;
        border-radius: 999px;
        background: #ffe9d7;
        font-size: 12px;
        margin: 2px;
        gap: 6px;
    }
    .pill button {
        padding: 0 6px;
        font-size: 11px;
        background: transparent;
        color: #ff4b24;
        box-shadow: none;
    }

    .input-line {
        display: flex;
        gap: 8px;
        margin-bottom: 8px;
    }
    .input-line input[type="text"] {
        flex: 1;
        padding: 7px;
        border-radius: 9px;
        border: 1px solid #ffd1a4;
        font-size: 13px;
        background: #fffdfa;
    }

    /* ìˆ™ì œ ì¹´ë“œ */
    .space-card {
        margin-bottom: 10px;
        padding: 10px;
        border-radius: 12px;
        background: #fffdf8;
        border: 1px solid #ffe4c9;
        box-shadow: 0 2px 6px rgba(0,0,0,0.03);
    }

    .space-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 6px;
        margin-bottom: 6px;
    }

    .space-main {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .badge-nick {
        font-size: 13px;
        font-weight: 600;
        padding: 4px 10px;
        border-radius: 999px;
        background: #ffe0c2;
        color: #8b4b20;
    }

    .badge-id {
        font-size: 11px;
        padding: 4px 8px;
        border-radius: 999px;
        background: #fff6eb;
        color: #a85a23;
        display: inline-flex;
        align-items: center;
        gap: 4px;
    }

    .badge-id button {
        padding: 2px 6px;
        font-size: 10px;
        border-radius: 999px;
        background: #ffbf86;
        color: #fff;
    }

    .count-row {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-bottom: 6px;
    }

    .count-chip {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 8px;
        border-radius: 999px;
        background: #fff2de;
        font-size: 11px;
    }

    .count-label {
        min-width: 32px;
        color: #8b4b20;
    }

    .count-input {
        width: 45px;
        padding: 3px 0;
        border-radius: 8px;
        border: 1px solid #ffd1a4;
        background: #fffdfa;
        text-align: center;
        font-size: 11px;
    }

    .memo-balloon-row {
        display: flex;
        gap: 8px;
        margin-top: 4px;
        flex-wrap: wrap;
    }

    .memo-block {
        flex: 1 1 60%;
    }

    .balloon-block {
        flex: 0 0 90px;
    }

    .small-label {
        font-size: 12px;
        color: #79533a;
        margin-bottom: 4px;
    }

    .balloon-input {
        width: 100%;
        padding: 6px;
        border-radius: 9px;
        border: 1px solid #ffd1a4;
        text-align: center;
        font-size: 12px;
        background: #fffdfa;
    }

    @media (min-width: 720px) {
        body {
            max-width: 640px;
            margin: 0 auto;
        }
    }
</style>
</head>

<body>

<h1>ğŸ¥• ë‹¹ - ìˆ™ì œ ê´€ë¦¬ì</h1>
<div class="tag">ê´€ë¦¬ì ID: ë‹¹ (ì£¼í™©)</div>

<!-- ì˜¤ëŠ˜ì˜ í•œë§ˆë”” -->
<div class="card">
    <div class="section-title">ğŸ“Œ ì˜¤ëŠ˜ì˜ í•œë§ˆë”” <span class="sub">(ê´€ë¦¬ì â†” ì‚¬ìš©ì)</span></div>

    <div class="label-line">ğŸ¥• ê´€ë¦¬ì â†’ ì‚¬ìš©ì</div>
    <textarea id="adminMessage" placeholder="ë‚­ì—ê²Œ ì˜¤ëŠ˜ ì „í•˜ê³  ì‹¶ì€ ë§"></textarea>
    <div style="margin-top:6px; text-align:right;">
        <button onclick="saveAdminMessage()">ê´€ë¦¬ì í•œë§ˆë”” ì €ì¥</button>
    </div>

    <div style="height:10px;"></div>

    <div class="label-line">ğŸ° ì‚¬ìš©ì â†’ ê´€ë¦¬ì</div>
    <div id="userMessageBox"
         style="white-space:pre-line; padding:8px; border-radius:10px; border:1px solid #ffd7c2; background:#fff8f3; font-size:13px;">
        (ì•„ì§ ì‚¬ìš©ì ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤)
    </div>
</div>

<!-- ì˜¤ëŠ˜ ìˆ™ì œ ìš”ì•½ -->
<div class="card">
    <div class="section-title">
        ğŸ“¦ <span id="todayTitleText"></span>
    </div>
    <div class="small-helper">â€» ì˜¤ëŠ˜ ê¸°ì¤€ìœ¼ë¡œ ì§ì ‘ ìˆ«ìë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.</div>

    <table class="summary-table">
        <tr>
            <td class="summary-cell">
                <div class="summary-cell-inner">
                    <div class="summary-label">ë°°ë¯¼</div>
                    <input id="today-ë°°ë¯¼" type="number" min="0" value="0" class="summary-input">
                </div>
            </td>
            <td class="summary-empty"></td>
            <td class="summary-cell">
                <div class="summary-cell-inner">
                    <div class="summary-label">ì—­íŒ¬</div>
                    <input id="today-ì—­íŒ¬" type="number" min="0" value="0" class="summary-input">
                </div>
            </td>
        </tr>
        <tr>
            <td class="summary-cell">
                <div class="summary-cell-inner">
                    <div class="summary-label">ë°©ì…€</div>
                    <input id="today-ë°©ì…€" type="number" min="0" value="0" class="summary-input">
                </div>
            </td>
            <td class="summary-cell">
                <div class="summary-cell-inner">
                    <div class="summary-label">ì •ì„±</div>
                    <input id="today-ì •ì„±" type="number" min="0" value="0" class="summary-input">
                </div>
            </td>
            <td class="summary-cell">
                <div class="summary-cell-inner">
                    <div class="summary-label">ì˜ìƒ</div>
                    <input id="today-ì˜ìƒ" type="number" min="0" value="0" class="summary-input">
                </div>
            </td>
        </tr>
        <tr>
            <td class="summary-cell">
                <div class="summary-cell-inner">
                    <div class="summary-label">ìˆ™ì œ</div>
                    <input id="today-ìˆ™ì œ" type="number" min="0" value="0" class="summary-input">
                </div>
            </td>
            <td class="summary-cell">
                <div class="summary-cell-inner">
                    <div class="summary-label">ì›€ì§¤</div>
                    <input id="today-ì›€ì§¤" type="number" min="0" value="0" class="summary-input">
                </div>
            </td>
            <td class="summary-cell">
                <div class="summary-cell-inner">
                    <div class="summary-label">ì‚¬ì§„</div>
                    <input id="today-ì‚¬ì§„" type="number" min="0" value="0" class="summary-input">
                </div>
            </td>
        </tr>
    </table>

    <div style="margin-top:8px; text-align:right;">
        <button class="btn-sub" onclick="saveSummaryToday()">ì˜¤ëŠ˜ ìš”ì•½ ì €ì¥</button>
    </div>
</div>

<!-- ë°€ë¦° ìˆ™ì œ -->
<div class="card">
    <div class="section-title">ğŸ“¦ ë°€ë¦° ìˆ™ì œ</div>
    <div class="small-helper">â€» ì „ì²´ ëˆ„ì ê°’ì…ë‹ˆë‹¤. í•„ìš” ì‹œ ì§ì ‘ ìˆ˜ì •í•˜ì„¸ìš”.</div>

    <table class="summary-table">
        <tr>
            <td class="summary-cell">
                <div class="summary-cell-inner">
                    <div class="summary-label">ë°°ë¯¼</div>
                    <input id="total-ë°°ë¯¼" type="number" min="0" value="0" class="summary-input">
                </div>
            </td>
            <td class="summary-empty"></td>
            <td class="summary-cell">
                <div class="summary-cell-inner">
                    <div class="summary-label">ì—­íŒ¬</div>
                    <input id="total-ì—­íŒ¬" type="number" min="0" value="0" class="summary-input">
                </div>
            </td>
        </tr>
        <tr>
            <td class="summary-cell">
                <div class="summary-cell-inner">
                    <div class="summary-label">ë°©ì…€</div>
                    <input id="total-ë°©ì…€" type="number" min="0" value="0" class="summary-input">
                </div>
            </td>
            <td class="summary-cell">
                <div class="summary-cell-inner">
                    <div class="summary-label">ì •ì„±</div>
                    <input id="total-ì •ì„±" type="number" min="0" value="0" class="summary-input">
                </div>
            </td>
            <td class="summary-cell">
                <div class="summary-cell-inner">
                    <div class="summary-label">ì˜ìƒ</div>
                    <input id="total-ì˜ìƒ" type="number" min="0" value="0" class="summary-input">
                </div>
            </td>
        </tr>
        <tr>
            <td class="summary-cell">
                <div class="summary-cell-inner">
                    <div class="summary-label">ìˆ™ì œ</div>
                    <input id="total-ìˆ™ì œ" type="number" min="0" value="0" class="summary-input">
                </div>
            </td>
            <td class="summary-cell">
                <div class="summary-cell-inner">
                    <div class="summary-label">ì›€ì§¤</div>
                    <input id="total-ì›€ì§¤" type="number" min="0" value="0" class="summary-input">
                </div>
            </td>
            <td class="summary-cell">
                <div class="summary-cell-inner">
                    <div class="summary-label">ì‚¬ì§„</div>
                    <input id="total-ì‚¬ì§„" type="number" min="0" value="0" class="summary-input">
                </div>
            </td>
        </tr>
    </table>

    <div style="margin-top:8px; text-align:right;">
        <button class="btn-sub" onclick="saveSummaryTotal()">ëˆ„ì  ìš”ì•½ ì €ì¥</button>
    </div>
</div>

<!-- ìˆ™ì œ ëŒ€ìƒ ì¶”ê°€ -->
<div class="card">
    <div class="section-title">ğŸ“‹ ìˆ™ì œ ëŒ€ìƒ ì¶”ê°€</div>
    <div class="label-line">ë‹‰ë„¤ì„ / ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ê³  í–‰ì„ ì¶”ê°€í•˜ì„¸ìš”.</div>
    <div class="input-line">
        <input type="text" id="newNick" placeholder="ë‹‰ë„¤ì„">
        <input type="text" id="newID" placeholder="ì•„ì´ë””">
        <button onclick="addSpace()">ì¶”ê°€</button>
    </div>
</div>

<!-- í•­ëª© ê´€ë¦¬ -->
<div class="card">
    <div class="section-title">ğŸ“Œ í•­ëª© ê´€ë¦¬</div>
    <div class="label-line">ì²´í¬(ìˆ«ì) í•­ëª©ì„ ì¶”ê°€í•˜ê±°ë‚˜ ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
    <div class="input-line">
        <input type="text" id="newField" placeholder="ìƒˆ í•­ëª© ì´ë¦„ (ì˜ˆ: ë°°ë¯¼ / ì—­íŒ¬ / ë°©ì…€ ...)">
        <button onclick="addField()">í•­ëª© ì¶”ê°€</button>
    </div>
    <div class="field-list">
        <div class="small-helper">ê´€ë¦¬ ì¹´ë“œì— í‘œì‹œë˜ëŠ” í•­ëª© ëª©ë¡ì…ë‹ˆë‹¤.</div>
        <div id="fieldPills"></div>
    </div>
</div>

<!-- ìˆ™ì œ ì¹´ë“œ ëª©ë¡ -->
<div class="card">
    <div class="section-title">ğŸ“¦ ìˆ™ì œ ì¹´ë“œ</div>
    <div class="small-helper">ê° ì¹´ë“œì—ì„œ ì˜¤ëŠ˜ í•´ì•¼ í•  ìˆ™ì œ ìˆ˜ëŸ‰, ë©”ëª¨, í’ì„  ê°¯ìˆ˜ë¥¼ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ëª¨ë‘ ì™„ë£Œí•œ ì¹´ë“œëŠ” â€˜ì™„ë£Œâ€™ ë²„íŠ¼ìœ¼ë¡œ ì‚­ì œí•  ìˆ˜ ìˆì–´ìš”.</div>
    <div id="spacesContainer"></div>
</div>

<script>
/* Firebase ì´ˆê¸°í™” */
firebase.initializeApp({
    apiKey: "AIzaSyAHmLNi5VOuAE-gXnAg-fEfzylPZvzvfVo",
    authDomain: "daily-checklist-91e5a.firebaseapp.com",
    projectId: "daily-checklist-91e5a",
    storageBucket: "daily-checklist-91e5a.firebasestorage.app",
    messagingSenderId: "66394691958",
    appId: "1:66394691958:web:cf91f295456a2e10d18257"
});
const db = firebase.firestore();

/* Ref */
const todayMessagesRef = db.collection("today").doc("messages");
const summaryTodayRef  = db.collection("summary").doc("today");
const summaryTotalRef  = db.collection("summary").doc("total");
const configRef        = db.collection("config").doc("checklist");
const spacesRef        = db.collection("spaces");

/* ê³ ì • í†µê³„ í•­ëª© */
const statNames = ["ë°°ë¯¼","ì—­íŒ¬","ë°©ì…€","ì •ì„±","ì˜ìƒ","ìˆ™ì œ","ì›€ì§¤","ì‚¬ì§„"];
let fields = [];
let spacesData = [];

/* ì˜¤ëŠ˜ ì œëª© */
function setTodayTitle() {
    const now = new Date();
    const m = now.getMonth() + 1;
    const d = now.getDate();
    const w = ["ì¼","ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ","í† "][now.getDay()];
    document.getElementById("todayTitleText").innerText =
        `${m}ì›” ${d}ì¼(${w}) ìˆ™ì œ`;
}

/* ì˜¤ëŠ˜ì˜ í•œë§ˆë”” */
todayMessagesRef.onSnapshot(doc => {
    if (!doc.exists) {
        todayMessagesRef.set({
            adminMessage: "",
            userMessage: "",
            date: new Date().toISOString()
        }, { merge: true });
        return;
    }
    const data = doc.data() || {};
    document.getElementById("adminMessage").value = data.adminMessage || "";
    document.getElementById("userMessageBox").innerText =
        data.userMessage || "(ì•„ì§ ì‚¬ìš©ì ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤)";
});

function saveAdminMessage() {
    const msg = document.getElementById("adminMessage").value || "";
    todayMessagesRef.set({
        adminMessage: msg,
        date: new Date().toISOString()
    }, { merge: true }).then(() => {
        alert("ê´€ë¦¬ì í•œë§ˆë””ë¥¼ ì €ì¥í–ˆì–´ìš”.");
    }).catch(e => {
        console.error(e);
        alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.");
    });
}

/* ìš”ì•½ - ê¸°ë³¸ê°’ */
const emptySummary = {};
statNames.forEach(n => emptySummary[n] = 0);

/* ì˜¤ëŠ˜ ìš”ì•½ */
summaryTodayRef.onSnapshot(doc => {
    if (!doc.exists) {
        summaryTodayRef.set(emptySummary, { merge: true });
        return;
    }
    const data = doc.data() || {};
    statNames.forEach(name => {
        const el = document.getElementById("today-" + name);
        if (el) el.value = data[name] ?? 0;
    });
});

function saveSummaryToday() {
    const payload = {};
    statNames.forEach(name => {
        const el = document.getElementById("today-" + name);
        payload[name] = Number(el.value || 0);
    });
    payload.updatedAt = new Date();
    summaryTodayRef.set(payload, { merge: true })
        .then(() => alert("ì˜¤ëŠ˜ ìš”ì•½ì„ ì €ì¥í–ˆì–´ìš”."))
        .catch(e => {
            console.error(e);
            alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.");
        });
}

/* ëˆ„ì  ìš”ì•½ */
summaryTotalRef.onSnapshot(doc => {
    if (!doc.exists) {
        summaryTotalRef.set(emptySummary, { merge: true });
        return;
    }
    const data = doc.data() || {};
    statNames.forEach(name => {
        const el = document.getElementById("total-" + name);
        if (el) el.value = data[name] ?? 0;
    });
});

function saveSummaryTotal() {
    const payload = {};
    statNames.forEach(name => {
        const el = document.getElementById("total-" + name);
        payload[name] = Number(el.value || 0);
    });
    payload.updatedAt = new Date();
    summaryTotalRef.set(payload, { merge: true })
        .then(() => alert("ëˆ„ì  ìš”ì•½ì„ ì €ì¥í–ˆì–´ìš”."))
        .catch(e => {
            console.error(e);
            alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.");
        });
}

/* í•­ëª© ê´€ë¦¬ */
configRef.onSnapshot(doc => {
    if (!doc.exists) {
        configRef.set({ fields: [] });
        return;
    }
    fields = doc.data().fields || [];
    renderFieldPills();
    renderSpaces();
});

function addField() {
    const input = document.getElementById("newField");
    const name = input.value.trim();
    if (!name) return;

    configRef.update({
        fields: firebase.firestore.FieldValue.arrayUnion(name)
    }).then(() => {
        input.value = "";
    }).catch(err => {
        console.error(err);
        alert("í•­ëª© ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.");
    });
}

function deleteField(name) {
    if (!confirm(`"${name}" í•­ëª©ì„ ì‚­ì œí• ê¹Œìš”?`)) return;
    configRef.update({
        fields: firebase.firestore.FieldValue.arrayRemove(name)
    }).catch(err => {
        console.error(err);
        alert("í•­ëª© ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.");
    });
}

function renderFieldPills() {
    const wrap = document.getElementById("fieldPills");
    wrap.innerHTML = "";
    if (!fields.length) {
        wrap.innerHTML = '<div class="small-helper">ì•„ì§ ë“±ë¡ëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
    }
    fields.forEach(name => {
        const pill = document.createElement("div");
        pill.className = "pill";
        pill.innerHTML = `
            <span>${name}</span>
            <button type="button" onclick="deleteField('${name}')">X</button>
        `;
        wrap.appendChild(pill);
    });
}

/* ìˆ™ì œ ëŒ€ìƒ ì¶”ê°€ */
function addSpace() {
    const nickEl = document.getElementById("newNick");
    const idEl   = document.getElementById("newID");
    const nickname = nickEl.value.trim();
    const userid   = idEl.value.trim();
    if (!nickname || !userid) {
        alert("ë‹‰ë„¤ì„ê³¼ ì•„ì´ë””ë¥¼ ëª¨ë‘ ì…ë ¥í•´ ì£¼ì„¸ìš”.");
        return;
    }

    spacesRef.add({
        nickname,
        userid,
        memo: "",
        balloon: 0,
        counts: {}
    }).then(() => {
        nickEl.value = "";
        idEl.value = "";
    }).catch(err => {
        console.error(err);
        alert("í–‰ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.");
    });
}

/* spaces ì‹¤ì‹œê°„ */
spacesRef.onSnapshot(snapshot => {
    spacesData = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
    renderSpaces();
});

/* ê³µí†µ ìœ í‹¸ */
function copyUserId(value) {
    if (!value) return;
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(value).then(() => {
            alert("ì•„ì´ë””ë¥¼ ë³µì‚¬í–ˆì–´ìš”: " + value);
        }).catch(() => {
            alert("ë³µì‚¬ ì¤‘ ë¬¸ì œê°€ ìƒê²¼ì–´ìš”. ì§ì ‘ ë³µì‚¬í•´ ì£¼ì„¸ìš”.");
        });
    } else {
        alert("ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” ìë™ ë³µì‚¬ê°€ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì§ì ‘ ë³µì‚¬í•´ ì£¼ì„¸ìš”.");
    }
}

function updateSpaceField(docId, field, value) {
    spacesRef.doc(docId).update({ [field]: value })
        .catch(err => {
            console.error(err);
            alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.");
        });
}

function updateCount(docId, field, value) {
    const num = Math.max(0, Number(value || 0));
    spacesRef.doc(docId).update({
        ["counts." + field]: num
    }).catch(err => {
        console.error(err);
        alert("ìˆ˜ëŸ‰ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.");
    });
}

function updateBalloon(docId, value) {
    const num = Math.max(0, Number(value || 0));
    spacesRef.doc(docId).update({
        balloon: num
    }).catch(err => {
        console.error(err);
        alert("í’ì„  ìˆ˜ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.");
    });
}

function completeSpace(docId) {
    if (!confirm("ì •ë§ ì´ ìˆ™ì œë¥¼ ëª¨ë‘ ì™„ë£Œí–ˆë‚˜ìš”?\ní™•ì¸ì„ ëˆ„ë¥´ë©´ ì¹´ë“œê°€ ì‚­ì œë©ë‹ˆë‹¤.")) return;
    spacesRef.doc(docId).delete().catch(err => {
        console.error(err);
        alert("ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.");
    });
}

/* ì¹´ë“œ ë Œë” */
function renderSpaces() {
    const container = document.getElementById("spacesContainer");
    container.innerHTML = "";

    if (!spacesData.length) {
        container.innerHTML = '<div class="small-helper">ì•„ì§ ì¶”ê°€ëœ ìˆ™ì œ ëŒ€ìƒì´ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
    }

    spacesData.forEach(item => {
        const card = document.createElement("div");
        card.className = "space-card";

        const counts = item.counts || {};
        const balloon = item.balloon ?? 0;

        const safeNick = (item.nickname || "").replace(/"/g,'&quot;');
        const safeUser = (item.userid || "").replace(/</g,'&lt;');
        const safeMemo = (item.memo || "").replace(/</g,'&lt;');

        const fieldChips = (fields && fields.length ? fields : statNames).map(name => {
            const v = typeof counts[name] === "number" ? counts[name] : 0;
            return `
            <div class="count-chip">
                <span class="count-label">${name}</span>
                <input type="number" min="0" class="count-input"
                       value="${v}"
                       onchange="updateCount('${item.id}','${name}',this.value)">
            </div>`;
        }).join("");

        card.innerHTML = `
            <div class="space-header">
                <div class="space-main">
                    <div class="badge-nick">
                        ë‹‰ë„¤ì„:
                        <input type="text"
                               value="${safeNick}"
                               style="border:none;background:transparent;width:140px;font-size:13px;"
                               onchange="updateSpaceField('${item.id}','nickname',this.value)">
                    </div>
                    <div class="badge-id">
                        <span>ì•„ì´ë””: ${safeUser}</span>
                        <button type="button"
                            onclick="copyUserId('${(item.userid || "").replace(/'/g,"\\'")}')">
                            ë³µì‚¬
                        </button>
                    </div>
                </div>
                <button type="button" class="btn-danger" onclick="completeSpace('${item.id}')">
                    ì™„ë£Œ
                </button>
            </div>

            <div class="count-row">
                ${fieldChips}
            </div>

            <div class="memo-balloon-row">
                <div class="memo-block">
                    <div class="small-label">ë©”ëª¨</div>
                    <textarea onchange="updateSpaceField('${item.id}','memo',this.value)">${safeMemo}</textarea>
                </div>
                <div class="balloon-block">
                    <div class="small-label">í’ì„ </div>
                    <input type="number" min="0" class="balloon-input"
                           value="${balloon}"
                           onchange="updateBalloon('${item.id}',this.value)">
                </div>
            </div>
        `;

        container.appendChild(card);
    });
}

/* ì´ˆê¸° */
document.addEventListener("DOMContentLoaded", () => {
    setTodayTitle();
});
</script>

</body>
</html>
