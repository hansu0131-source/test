<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ğŸ° ë‚­ - ìˆ™ì œ ì²´í¬</title>

<!-- Firebase compat SDK -->
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

<style>
  * { box-sizing: border-box; }

  body {
    background: #ffe5f3;
    font-family: -apple-system, BlinkMacSystemFont, "Pretendard", system-ui, sans-serif;
    margin: 0;
    padding: 16px;
    color: #5b3050;
  }

  h1 {
    text-align: center;
    color: #ff6fa8;
    margin: 0 0 6px 0;
    font-size: 22px;
  }

  .tag {
    text-align: center;
    font-size: 12px;
    color: #fff;
    background: #ff9ac5;
    padding: 4px 12px;
    border-radius: 999px;
    display: inline-block;
    margin-left: 50%;
    transform: translateX(-50%);
    margin-bottom: 18px;
  }

  .section-title {
    font-size: 15px;
    font-weight: 700;
    margin-bottom: 8px;
    color: #ff6fa8;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .section-title span.sub {
    font-size: 12px;
    font-weight: 400;
    color: #b05787;
  }

  .card {
    background: #ffffff;
    padding: 12px;
    border-radius: 14px;
    box-shadow: 0 3px 10px rgba(255,120,180,0.22);
    margin-bottom: 16px;
  }

  textarea {
    width: 100%;
    min-height: 70px;
    border-radius: 10px;
    border: 1px solid #ffbee0;
    padding: 8px;
    resize: vertical;
    font-family: inherit;
    font-size: 13px;
    background: #fff7fb;
  }

  button {
    padding: 8px 14px;
    border: none;
    border-radius: 999px;
    background: #ff6fa8;
    color: white;
    font-weight: 600;
    cursor: pointer;
    font-size: 13px;
  }
  button:active { transform: translateY(1px); }

  .btn-sub { background: #ffc4df; color: #b04575; }
  .btn-complete { background:#ff7fb3; color:#fff; font-size:12px; padding:6px 12px; }

  .small-helper {
    font-size: 11px;
    color: #b87a9c;
    margin-top: 2px;
  }

  .input-small-label {
    font-size: 12px;
    color: #8a456a;
    margin-bottom: 4px;
  }

  /* --- ìš”ì•½ 3Ã—3 ê·¸ë¦¬ë“œ (í•‘í¬ ë²„ì „) --- */
  .summary-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
    margin-top: 6px;
  }

  .summary-box {
    background: #ffe5f5;
    border-radius: 14px;
    padding: 8px 6px;
    text-align: center;
    box-shadow: 0 2px 4px rgba(255,150,210,0.18);
  }

  .summary-box.sum {
    background: #ffd3f0;
  }

  .summary-label {
    font-size: 12px;
    color: #b2467f;
    margin-bottom: 2px;
  }

  .summary-input-wrap {
    background: #fff7fc;
    border-radius: 999px;
    border: 1px solid #ffc3e7;
    padding: 4px 8px;
    display: inline-block;
    min-width: 54px;
  }

  .summary-input {
    width: 40px;
    text-align: center;
    border: none;
    background: transparent;
    font-size: 13px;
    color: #ff4090;
  }
  .summary-input:focus { outline:none; }

  /* --- ìˆ™ì œ ì¹´ë“œ (ì‚¬ìš©ììª½) --- */

  .space-card {
    margin-bottom: 10px;
    padding: 10px;
    border-radius: 16px;
    background: #fff8fe;
    border: 1px solid #ffd6f0;
    box-shadow: 0 2px 6px rgba(0,0,0,0.03);
  }

  .space-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 6px;
    margin-bottom: 10px;
  }

  .space-main {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .badge-nick {
    font-size: 13px;
    font-weight: 600;
    padding: 4px 10px;
    border-radius: 999px;
    background: #ffd3ed;
    color: #923c68;
  }

  .badge-id {
    font-size: 11px;
    padding: 4px 8px;
    border-radius: 999px;
    background: #ffe9f6;
    color: #aa4c78;
    display: inline-flex;
    align-items: center;
    gap: 4px;
  }

  .badge-id button {
    padding: 2px 6px;
    font-size: 10px;
    border-radius: 999px;
    background: #ff9fcb;
    color: #fff;
  }

  .space-stats {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }

  .stat-box {
    flex: 1 1 calc(50% - 8px);
    min-width: 110px;
    background: #ffe8f8;
    border-radius: 14px;
    padding: 8px 6px;
    text-align: center;
  }

  .stat-label {
    font-size: 12px;
    color: #b2467f;
    margin-bottom: 2px;
  }

  .stat-input-wrap {
    border-radius: 999px;
    border: 1px solid #ffc3e7;
    background: #fff;
    padding: 4px 10px;
    display: inline-block;
    min-width: 60px;
  }

  .stat-input {
    width: 44px;
    border: none;
    background: transparent;
    text-align: center;
    font-size: 14px;
    color: #ff4090;
  }
  .stat-input:focus { outline:none; }

  .space-bottom {
    display: flex;
    gap: 8px;
    margin-top: 8px;
  }

  .space-memo { flex: 1; }

  .space-balloons {
    width: 80px;
    text-align: center;
  }

  .space-balloons-input {
    width: 100%;
    border-radius: 10px;
    border: 1px solid #ffc3e7;
    padding: 6px 4px;
    text-align: center;
    font-size: 13px;
    background: #fff7fb;
  }

  @media (min-width: 720px) {
    body {
      max-width: 640px;
      margin: 0 auto;
    }
  }
</style>
</head>

<body>
<h1>ğŸ° ë‚­ - ìˆ™ì œ ì²´í¬</h1>
<div class="tag">ì‚¬ìš©ì ID: ë‚­ (í•‘í¬)</div>

<!-- ì˜¤ëŠ˜ì˜ í•œë§ˆë”” -->
<div class="card">
  <div class="section-title">ğŸ“Œ ì˜¤ëŠ˜ì˜ í•œë§ˆë””</div>

  <div class="input-small-label">ğŸ¥• ê´€ë¦¬ì â†’ ë‚­</div>
  <div id="adminMessageBox"
       style="white-space:pre-line; padding:8px; border-radius:10px; border:1px solid #ffc3e0; background:#fff8fb; font-size:13px;">
    (ê´€ë¦¬ìê°€ ì•„ì§ ë©”ì‹œì§€ë¥¼ ë‚¨ê¸°ì§€ ì•Šì•˜ì–´ìš”)
  </div>

  <div style="height:10px;"></div>

  <div class="input-small-label">ğŸ° ë‚­ â†’ ê´€ë¦¬ì</div>
  <textarea id="userMessage" placeholder="ì˜¤ëŠ˜ í•˜ê³  ì‹¶ì€ ë§ì„ ì ì–´ì£¼ì„¸ìš”"></textarea>
  <div style="margin-top:6px; text-align:right;">
    <button onclick="saveUserMessage()">ì €ì¥</button>
  </div>
</div>

<!-- ì˜¤ëŠ˜ ìˆ™ì œ ìš”ì•½ -->
<div class="card">
  <div class="section-title">
    ğŸ“¦ <span id="todayTitleDate">ì˜¤ëŠ˜ ìˆ™ì œ</span>
  </div>

  <div class="summary-grid">
    <!-- 1í–‰ -->
    <div class="summary-box">
      <div class="summary-label">ë°°ë¯¼</div>
      <div class="summary-input-wrap">
        <input id="today-ë°°ë¯¼" type="number" class="summary-input" value="0" />
      </div>
    </div>
    <div class="summary-box">
      <div class="summary-label">ë°©ì…€</div>
      <div class="summary-input-wrap">
        <input id="today-ë°©ì…€" type="number" class="summary-input" value="0" />
      </div>
    </div>
    <div class="summary-box">
      <div class="summary-label">ì›€ì§¤</div>
      <div class="summary-input-wrap">
        <input id="today-ì›€ì§¤" type="number" class="summary-input" value="0" />
      </div>
    </div>
    <!-- 2í–‰ -->
    <div class="summary-box">
      <div class="summary-label">ì—­íŒ¬</div>
      <div class="summary-input-wrap">
        <input id="today-ì—­íŒ¬" type="number" class="summary-input" value="0" />
      </div>
    </div>
    <div class="summary-box">
      <div class="summary-label">ì •ì„±</div>
      <div class="summary-input-wrap">
        <input id="today-ì •ì„±" type="number" class="summary-input" value="0" />
      </div>
    </div>
    <div class="summary-box">
      <div class="summary-label">ì‚¬ì§„</div>
      <div class="summary-input-wrap">
        <input id="today-ì‚¬ì§„" type="number" class="summary-input" value="0" />
      </div>
    </div>
    <!-- 3í–‰ -->
    <div class="summary-box sum">
      <div class="summary-label">í•©ê³„</div>
      <div class="summary-input-wrap">
        <input id="today-í•©ê³„-left" type="number" class="summary-input" value="0" />
      </div>
    </div>
    <div class="summary-box">
      <div class="summary-label">ì˜ìƒ</div>
      <div class="summary-input-wrap">
        <input id="today-ì˜ìƒ" type="number" class="summary-input" value="0" />
      </div>
    </div>
    <div class="summary-box sum">
      <div class="summary-label">í•©ê³„</div>
      <div class="summary-input-wrap">
        <input id="today-í•©ê³„-right" type="number" class="summary-input" value="0" />
      </div>
    </div>
  </div>

  <div style="margin-top:8px; text-align:right;">
    <button class="btn-sub" onclick="saveSummary('today')">ì˜¤ëŠ˜ ìš”ì•½ ì €ì¥</button>
  </div>
</div>

<!-- ë°€ë¦° ìˆ™ì œ ìš”ì•½ -->
<div class="card">
  <div class="section-title">ğŸ“¦ ë°€ë¦° ìˆ™ì œ</div>

  <div class="summary-grid">
    <!-- 1í–‰ -->
    <div class="summary-box">
      <div class="summary-label">ë°°ë¯¼</div>
      <div class="summary-input-wrap">
        <input id="late-ë°°ë¯¼" type="number" class="summary-input" value="0" />
      </div>
    </div>
    <div class="summary-box">
      <div class="summary-label">ë°©ì…€</div>
      <div class="summary-input-wrap">
        <input id="late-ë°©ì…€" type="number" class="summary-input" value="0" />
      </div>
    </div>
    <div class="summary-box">
      <div class="summary-label">ì›€ì§¤</div>
      <div class="summary-input-wrap">
        <input id="late-ì›€ì§¤" type="number" class="summary-input" value="0" />
      </div>
    </div>
    <!-- 2í–‰ -->
    <div class="summary-box">
      <div class="summary-label">ì—­íŒ¬</div>
      <div class="summary-input-wrap">
        <input id="late-ì—­íŒ¬" type="number" class="summary-input" value="0" />
      </div>
    </div>
    <div class="summary-box">
      <div class="summary-label">ì •ì„±</div>
      <div class="summary-input-wrap">
        <input id="late-ì •ì„±" type="number" class="summary-input" value="0" />
      </div>
    </div>
    <div class="summary-box">
      <div class="summary-label">ì‚¬ì§„</div>
      <div class="summary-input-wrap">
        <input id="late-ì‚¬ì§„" type="number" class="summary-input" value="0" />
      </div>
    </div>
    <!-- 3í–‰ -->
    <div class="summary-box sum">
      <div class="summary-label">í•©ê³„</div>
      <div class="summary-input-wrap">
        <input id="late-í•©ê³„-left" type="number" class="summary-input" value="0" />
      </div>
    </div>
    <div class="summary-box">
      <div class="summary-label">ì˜ìƒ</div>
      <div class="summary-input-wrap">
        <input id="late-ì˜ìƒ" type="number" class="summary-input" value="0" />
      </div>
    </div>
    <div class="summary-box sum">
      <div class="summary-label">í•©ê³„</div>
      <div class="summary-input-wrap">
        <input id="late-í•©ê³„-right" type="number" class="summary-input" value="0" />
      </div>
    </div>
  </div>

  <div style="margin-top:8px; text-align:right;">
    <button class="btn-sub" onclick="saveSummary('late')">ë°€ë¦° ìˆ™ì œ ì €ì¥</button>
  </div>
</div>

<!-- ìˆ™ì œ ì¹´ë“œ -->
<div class="card">
  <div class="section-title">ğŸ“¦ ìˆ™ì œ ì¹´ë“œ</div>
  <div class="small-helper">ê´€ë¦¬ìê°€ ë§Œë“¤ì–´ ì¤€ ì¹´ë“œì…ë‹ˆë‹¤. ìˆ«ìë¥¼ ì±„ìš°ê³ , ë©”ëª¨ì™€ í’ì„  ê°¯ìˆ˜ë¥¼ ì ì€ ë’¤ ë‹¤ ëë‚˜ë©´ â€œì™„ë£ŒğŸ°â€ë¥¼ ëˆŒëŸ¬ ì£¼ì„¸ìš”.</div>
  <div id="spacesContainer"></div>
</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyAHmLNi5VOuAE-gXnAg-fEfzylPZvzvfVo",
    authDomain: "daily-checklist-91e5a.firebaseapp.com",
    projectId: "daily-checklist-91e5a",
    storageBucket: "daily-checklist-91e5a.firebasestorage.app",
    messagingSenderId: "66394691958",
    appId: "1:66394691958:web:cf91f295456a2e10d18257",
    measurementId: "G-87WK4N4EGH"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const STAT_KEYS = ["ë°°ë¯¼", "ë°©ì…€", "ì›€ì§¤", "ì—­íŒ¬", "ì •ì„±", "ì‚¬ì§„", "ì˜ìƒ"];
  const SUM_LEFT = "í•©ê³„ì¢Œ";
  const SUM_RIGHT = "í•©ê³„ìš°";

  const emptySummary = {};
  STAT_KEYS.forEach(k => emptySummary[k] = 0);
  emptySummary[SUM_LEFT] = 0;
  emptySummary[SUM_RIGHT] = 0;

  const todayMessagesRef = db.collection("today").doc("messages");
  const summaryTodayRef  = db.collection("summary").doc("today_v2");
  const summaryLateRef   = db.collection("summary").doc("late_v2");
  const configRef        = db.collection("config").doc("checklist");
  const spacesRef        = db.collection("spaces");

  let fields = [];
  let spacesData = [];

  // ì˜¤ëŠ˜ ë‚ ì§œ íƒ€ì´í‹€
  (function setTitle(){
    const now = new Date();
    const m = now.getMonth() + 1;
    const d = now.getDate();
    const wNames = ["ì¼","ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ","í† "];
    const w = wNames[now.getDay()];
    document.getElementById("todayTitleDate").innerText = `${m}ì›” ${d}ì¼(${w}) ìˆ™ì œ`;
  })();

  /* í•œë§ˆë”” ì„¹ì…˜ */
  todayMessagesRef.onSnapshot(doc=>{
    if (!doc.exists) return;
    const data = doc.data();
    document.getElementById("adminMessageBox").innerText =
      data.adminMessage || "(ê´€ë¦¬ìê°€ ì•„ì§ ë©”ì‹œì§€ë¥¼ ë‚¨ê¸°ì§€ ì•Šì•˜ì–´ìš”)";
    document.getElementById("userMessage").value = data.userMessage || "";
  });

  function saveUserMessage(){
    const msg = document.getElementById("userMessage").value;
    todayMessagesRef.set({
      userMessage: msg,
      date: new Date().toISOString()
    }, { merge:true }).then(()=>{
      alert("ë©”ì‹œì§€ë¥¼ ë³´ëƒˆì–´ìš”!");
    }).catch(e=>{
      console.error(e);
      alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.");
    });
  }

  /* ìš”ì•½ ê³µí†µ í•¨ìˆ˜ (ê´€ë¦¬ìì™€ ë™ì¼ ë¡œì§) */

  function renderSummary(prefix, data) {
    const d = Object.assign({}, emptySummary, data || {});
    function set(id, val){
      const el = document.getElementById(prefix + "-" + id);
      if (el) el.value = val ?? 0;
    }
    STAT_KEYS.forEach(name => set(name, d[name]));
    const left = (d[SUM_LEFT] != null)
      ? d[SUM_LEFT]
      : (Number(d["ë°°ë¯¼"]||0) + Number(d["ì—­íŒ¬"]||0));
    const right = (d[SUM_RIGHT] != null)
      ? d[SUM_RIGHT]
      : (Number(d["ì›€ì§¤"]||0) + Number(d["ì‚¬ì§„"]||0));
    set("í•©ê³„-left", left);
    set("í•©ê³„-right", right);
  }

  function collectSummary(prefix) {
    const payload = {};
    function get(id){
      const el = document.getElementById(prefix + "-" + id);
      return el ? Number(el.value || 0) : 0;
    }
    STAT_KEYS.forEach(name => payload[name] = get(name));
    payload[SUM_LEFT] = get("í•©ê³„-left");
    payload[SUM_RIGHT] = get("í•©ê³„-right");
    payload.updatedAt = new Date();
    return payload;
  }

  function setupAutoSum(prefix) {
    function recalc() {
      function get(id){
        const el = document.getElementById(prefix + "-" + id);
        return el ? Number(el.value || 0) : 0;
      }
      const left = get("ë°°ë¯¼") + get("ì—­íŒ¬");
      const right = get("ì›€ì§¤") + get("ì‚¬ì§„");
      const leftEl = document.getElementById(prefix + "-í•©ê³„-left");
      const rightEl = document.getElementById(prefix + "-í•©ê³„-right");
      if (leftEl) leftEl.value = left;
      if (rightEl) rightEl.value = right;
    }
    ["ë°°ë¯¼","ì—­íŒ¬","ì›€ì§¤","ì‚¬ì§„"].forEach(name=>{
      const el = document.getElementById(prefix + "-" + name);
      if (el) el.addEventListener("input", recalc);
    });
  }

  function saveSummary(which){
    const prefix = (which === "today") ? "today" : "late";
    const ref = (which === "today") ? summaryTodayRef : summaryLateRef;
    const payload = collectSummary(prefix);
    ref.set(payload, { merge:true }).then(()=>{
      alert((which === "today" ? "ì˜¤ëŠ˜" : "ë°€ë¦°") + " ìˆ™ì œë¥¼ ì €ì¥í–ˆì–´ìš”.");
    }).catch(e=>{
      console.error(e);
      alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.");
    });
  }

  summaryTodayRef.onSnapshot(doc=>{
    renderSummary("today", doc.exists ? doc.data() : emptySummary);
    setupAutoSum("today");
  });

  summaryLateRef.onSnapshot(doc=>{
    renderSummary("late", doc.exists ? doc.data() : emptySummary);
    setupAutoSum("late");
  });

  /* ì¹´ë“œìš© í•­ëª© ì •ë³´ */
  configRef.onSnapshot(doc=>{
    fields = doc.exists ? (doc.data().fields || []) : [];
    renderSpaces();
  });

  /* spaces ë¡œë“œ */
  spacesRef.onSnapshot(snapshot=>{
    spacesData = snapshot.docs.map(d=>({ id:d.id, ...d.data() }));
    renderSpaces();
  });

  function copyUserId(value){
    if (!value) return;
    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(value).then(()=>{
        alert("ì•„ì´ë””ë¥¼ ë³µì‚¬í–ˆì–´ìš”: " + value);
      }).catch(()=>{
        alert("ë³µì‚¬ ì¤‘ ë¬¸ì œê°€ ìƒê²¼ì–´ìš”. ì§ì ‘ ë³µì‚¬í•´ ì£¼ì„¸ìš”.");
      });
    } else {
      alert("ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” ìë™ ë³µì‚¬ê°€ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì§ì ‘ ë³µì‚¬í•´ ì£¼ì„¸ìš”.");
    }
  }

  function updateSpaceField(id, field, value){
    spacesRef.doc(id).update({ [field]: value })
      .catch(err=>{
        console.error(err);
        alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.");
      });
  }

  function updateSpaceCount(id, fieldName, value){
    const num = Number(value || 0);
    spacesRef.doc(id).update({
      [`counts.${fieldName}`]: num
    }).catch(err=>{
      console.error(err);
      alert("ì¹´ìš´íŠ¸ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.");
    });
  }

  function completeSpace(id){
    if (!confirm("ì •ë§ ì´ ì¹´ë“œë¥¼ ëª¨ë‘ ì™„ë£Œí–ˆë‚˜ìš”?\nì™„ë£Œí•˜ë©´ ëª©ë¡ì—ì„œ ì‚¬ë¼ì§‘ë‹ˆë‹¤.")) return;
    spacesRef.doc(id).delete()
      .catch(err=>{
        console.error(err);
        alert("ì™„ë£Œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.");
      });
  }

  function renderSpaces(){
    const container = document.getElementById("spacesContainer");
    container.innerHTML = "";

    if (!spacesData.length) {
      container.innerHTML = '<div class="small-helper">ì•„ì§ ë“±ë¡ëœ ìˆ™ì œ ì¹´ë“œê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
      return;
    }

    spacesData.forEach(item=>{
      const counts = item.counts || {};
      const card = document.createElement("div");
      card.className = "space-card";

      const statsHTML = (fields && fields.length)
        ? fields.map(name=>{
            const val = counts[name] ?? 0;
            return `
              <div class="stat-box">
                <div class="stat-label">${name}</div>
                <div class="stat-input-wrap">
                  <input type="number" class="stat-input"
                         value="${val}"
                         onchange="updateSpaceCount('${item.id}','${name}',this.value)" />
                </div>
              </div>`;
          }).join("")
        : '<div class="small-helper">í•­ëª© ì •ë³´ê°€ ì•„ì§ ì„¤ì •ë˜ì§€ ì•Šì•˜ì–´ìš”.</div>';

      card.innerHTML = `
        <div class="space-header">
          <div class="space-main">
            <div class="badge-nick">ë‹‰ë„¤ì„: ${item.nickname || ""}</div>
            <div class="badge-id">
              <span>ì•„ì´ë””: ${item.userid || ""}</span>
              <button type="button" onclick="copyUserId('${item.userid || ""}')">ë³µì‚¬</button>
            </div>
          </div>
          <button class="btn-complete" type="button" onclick="completeSpace('${item.id}')">
            ì™„ë£Œ ğŸ°
          </button>
        </div>

        <div class="space-stats">
          ${statsHTML}
        </div>

        <div class="space-bottom">
          <div class="space-memo">
            <div class="input-small-label">ë©”ëª¨</div>
            <textarea onchange="updateSpaceField('${item.id}','memo',this.value)">${item.memo || ""}</textarea>
          </div>
          <div class="space-balloons">
            <div class="input-small-label">í’ì„ </div>
            <input type="number" min="0"
                   class="space-balloons-input"
                   value="${item.balloons ?? 0}"
                   onchange="updateSpaceField('${item.id}','balloons',Number(this.value||0))" />
          </div>
        </div>
      `;

      container.appendChild(card);
    });
  }
</script>
</body>
</html>
